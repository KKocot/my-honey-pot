---
/**
 * CommentCard - uses shared utilities
 */
import type { BridgeComment } from '../../lib/blog-logic'
import type { SiteSettings } from './types'
import {
  createCommentCardData,
  createCommentCardSettings,
  renderCommentCard,
} from '../../shared/components/comment-card'

interface Props {
  comment: BridgeComment
  settings?: SiteSettings
  layout?: 'list' | 'grid' | 'masonry'
}

const { comment, settings = {}, layout = 'list' } = Astro.props

// Create normalized comment data using shared utility
const commentData = createCommentCardData(comment)

// Create settings using shared utility
const cardSettings = createCommentCardSettings({
  commentShowAuthor: settings.commentShowAuthor,
  commentShowAvatar: settings.commentShowAvatar,
  commentAvatarSizePx: settings.commentAvatarSizePx,
  commentShowReplyContext: settings.commentShowReplyContext,
  commentShowTimestamp: settings.commentShowTimestamp,
  commentShowRepliesCount: settings.commentShowRepliesCount,
  commentShowVotes: settings.commentShowVotes,
  commentShowPayout: settings.commentShowPayout,
  commentShowViewLink: settings.commentShowViewLink,
  commentMaxLength: settings.commentMaxLength,
  commentPaddingPx: settings.commentPaddingPx,
})

// Animation settings (for CSS)
const cardHoverEffect = settings.cardHoverEffect || 'shadow'
const cardTransitionDuration = settings.cardTransitionDuration ?? 200
const cardHoverScale = settings.cardHoverScale ?? 1.02
const cardHoverShadow = settings.cardHoverShadow || 'md'
const cardHoverBrightness = settings.cardHoverBrightness ?? 1.0

// Shadow map for hover effects
const shadowMap: Record<string, string> = {
  sm: '0 1px 2px 0 rgb(0 0 0 / 0.05)',
  md: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
  lg: '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)',
  xl: '0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)',
  '2xl': '0 25px 50px -12px rgb(0 0 0 / 0.25)',
}

// Generate hover CSS based on effect type
let hoverTransform = ''
let hoverBoxShadow = ''
let hoverFilter = ''

if (cardHoverEffect === 'shadow') {
  hoverBoxShadow = shadowMap[cardHoverShadow] || shadowMap.md
} else if (cardHoverEffect === 'scale') {
  hoverTransform = `scale(${cardHoverScale})`
} else if (cardHoverEffect === 'lift') {
  hoverTransform = `scale(${cardHoverScale}) translateY(-4px)`
  hoverBoxShadow = shadowMap[cardHoverShadow] || shadowMap.lg
} else if (cardHoverEffect === 'glow') {
  hoverFilter = `brightness(${cardHoverBrightness})`
  hoverBoxShadow = '0 0 20px var(--color-primary)'
}

// Render using shared function
const commentCardHtml = renderCommentCard(commentData, cardSettings, layout)
---

<style define:vars={{ hoverTransform, hoverBoxShadow, hoverFilter, transitionDuration: `${cardTransitionDuration}ms` }}>
  .comment-card-wrapper :global(article) {
    transition: all var(--transitionDuration) ease-out;
  }
  .comment-card-wrapper :global(article:hover) {
    transform: var(--hoverTransform);
    box-shadow: var(--hoverBoxShadow);
    filter: var(--hoverFilter);
  }
</style>

<div class={`comment-card-wrapper ${cardHoverEffect === 'none' ? '' : 'cursor-pointer'}`}>
  <Fragment set:html={commentCardHtml} />
</div>
