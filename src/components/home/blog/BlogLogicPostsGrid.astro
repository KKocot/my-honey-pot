---
// SPDX-License-Identifier: AGPL-3.0-or-later
// Copyright (C) 2026 Krzysztof Kocot

import type { Post } from '../../../lib/blog-logic'
import type { SiteSettings } from '../types'
import {
  renderPostsGrid,
  type PostsGridSettings,
  type PostCardSettings,
  createPostCardDataFromPost,
  renderPostCard,
} from '../../../shared/components/post-card'

interface Props {
  posts: Post[]
  settings: SiteSettings
}

const { posts, settings } = Astro.props

// Layout settings
const postsLayout = settings.postsLayout || 'list'
const gridColumns = settings.gridColumns || 2
const cardGapPx = settings.cardGapPx ?? 24

// Card settings with defaults
const thumbnailSizePx = settings.thumbnailSizePx ?? 96
const cardPaddingPx = settings.cardPaddingPx ?? 24
const cardBorderRadiusPx = settings.cardBorderRadiusPx ?? 16
const titleSizePx = settings.titleSizePx ?? 20
const summaryMaxLength = settings.summaryMaxLength ?? 150
const cardBorder = settings.cardBorder !== false
const maxTags = settings.maxTags ?? 5

// postCardLayout is required for sections-based rendering
const postCardLayout = settings.postCardLayout

// Hover effect settings
const cardHoverEffect = settings.cardHoverEffect || 'none'
const cardTransitionDuration = settings.cardTransitionDuration ?? 200
const cardHoverScale = settings.cardHoverScale ?? 1.02
const cardHoverShadow = settings.cardHoverShadow ?? 'lg'
const cardHoverBrightness = settings.cardHoverBrightness ?? 1.05

// Build card settings
const cardSettings: PostCardSettings = {
  thumbnailSizePx,
  cardPaddingPx,
  cardBorderRadiusPx,
  titleSizePx,
  summaryMaxLength,
  maxTags,
  cardBorder,
  postCardLayout,
  cardHoverEffect,
  cardTransitionDuration,
  cardHoverScale,
  cardHoverShadow,
  cardHoverBrightness,
}

// Build grid settings
const gridSettings: PostsGridSettings = {
  layout: postsLayout as 'list' | 'grid' | 'masonry',
  columns: gridColumns,
  gap_px: cardGapPx,
}

// Determine if cards should be vertical (same logic as FullPreview)
const isVertical = postsLayout !== 'list'

// Render all post cards as HTML strings
const cards_html = await Promise.all(
  posts.map(async (post) => {
    const postData = await createPostCardDataFromPost(post, {
      thumbnailSizePx,
      maxTags,
      summaryMaxLength,
    })
    return renderPostCard(postData, cardSettings, isVertical, `/${post.permlink}`)
  })
)

// Wrap cards in appropriate grid layout
const gridHtml = renderPostsGrid(cards_html, gridSettings)
---

<Fragment set:html={gridHtml} />
