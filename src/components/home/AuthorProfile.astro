---
import type { DatabaseAccount, BridgeProfile, DynamicGlobalProperties, ManabarData } from '../../lib/hive'
import { convertVestsToHP, calculateEffectiveHP } from '../../lib/hive'

interface Props {
  username: string
  account: DatabaseAccount
  profile: BridgeProfile | null
  globalProperties: DynamicGlobalProperties | null
  votingManabar: ManabarData | null
  avatarSize: number
  showPostCount: boolean
  showRewards: boolean
  showAbout?: boolean
  showLocation?: boolean
  showWebsite?: boolean
  showJoinDate?: boolean
  showReputation?: boolean
  showFollowers?: boolean
  showFollowing?: boolean
  showVotingPower?: boolean
  showHiveBalance?: boolean
  showHbdBalance?: boolean
  showHivePower?: boolean
  showCoverImage?: boolean
  layout?: 'horizontal' | 'vertical'
}

const {
  username,
  account,
  profile,
  globalProperties,
  votingManabar,
  avatarSize,
  showPostCount,
  showRewards,
  showAbout = true,
  showLocation = true,
  showWebsite = true,
  showJoinDate = true,
  showReputation = true,
  showFollowers = true,
  showFollowing = true,
  showVotingPower = false,
  showHiveBalance = false,
  showHbdBalance = false,
  showHivePower = false,
  showCoverImage = true,
  layout = 'horizontal'
} = Astro.props

const isVertical = layout === 'vertical'

// Profile metadata from bridge.get_profile
const displayName = profile?.metadata?.profile?.name
const about = profile?.metadata?.profile?.about
const location = profile?.metadata?.profile?.location
const website = profile?.metadata?.profile?.website
const coverImage = profile?.metadata?.profile?.cover_image
const profileImage = profile?.metadata?.profile?.profile_image

// Stats from bridge.get_profile
const reputation = profile?.reputation
const followers = profile?.stats?.followers
const following = profile?.stats?.following
const joinDate = profile?.created ? new Date(profile.created) : null

// Financial data from database_api
const postCount = account.post_count
const postingRewardsVests = account.posting_rewards
const curationRewardsVests = account.curation_rewards
const totalRewardsVests = postingRewardsVests + curationRewardsVests

// Parse balance amounts (handles both string format "123.456 HIVE" and asset object format)
function parseBalance(balance: string | { amount: string; precision: number; nai: string }): number {
  if (typeof balance === 'string') {
    // Handle string format: "123.456 HIVE" or "123.456 HBD"
    return parseFloat(balance.replace(/\s*(HIVE|HBD|VESTS)$/i, ''))
  }
  // Handle asset object format: { amount: "123456", precision: 3, nai: "..." }
  return parseInt(balance.amount) / Math.pow(10, balance.precision)
}

const hiveBalance = parseBalance(account.balance as string | { amount: string; precision: number; nai: string })
const hbdBalance = parseBalance(account.hbd_balance as string | { amount: string; precision: number; nai: string })

// Calculate HP values using global properties
let hivePower = 0
let hpEarned = 0
if (globalProperties) {
  const { total_vesting_fund_hive, total_vesting_shares } = globalProperties

  // Effective HP (own + received - delegated)
  // account.vesting_shares etc. can be string or asset object format
  hivePower = calculateEffectiveHP(
    account.vesting_shares,
    account.delegated_vesting_shares,
    account.received_vesting_shares,
    total_vesting_fund_hive,
    total_vesting_shares
  )

  // HP Earned (posting + curation rewards converted from VESTS to HP)
  // Note: posting_rewards and curation_rewards are in VESTS (as numbers, not strings)
  hpEarned = convertVestsToHP(
    totalRewardsVests,
    total_vesting_fund_hive,
    total_vesting_shares
  )
}

// Use WAX-calculated voting power (accurate like Denser)
const votingPower = votingManabar?.percent ?? 0

// Format large numbers
function formatNumber(num: number): string {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K'
  return num.toString()
}

// Format date
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    year: 'numeric'
  })
}

// Avatar URL - prefer profile image from metadata, fallback to hive images
const avatarUrl = profileImage || `https://images.hive.blog/u/${username}/avatar`
---

<div class="bg-bg-card rounded-xl border border-border overflow-hidden">
  {/* Cover Image */}
  {showCoverImage && coverImage && (
    <div
      class="h-24 md:h-32 bg-cover bg-center"
      style={`background-image: url('${coverImage}');`}
    />
  )}

  <div class={`p-4 md:p-6 ${showCoverImage && coverImage ? '-mt-10 md:-mt-12' : ''}`}>
    <div class={isVertical ? 'flex flex-col items-center text-center' : 'flex items-start gap-4'}>
      {/* Avatar */}
      <img
        src={avatarUrl}
        alt={username}
        style={`width: ${avatarSize}px; height: ${avatarSize}px;`}
        class={`rounded-full border-4 border-bg-card ${isVertical ? 'mb-3' : ''} ${showCoverImage && coverImage ? 'ring-2 ring-border' : 'border-2 border-border'}`}
        onerror="this.src='/hive-logo.png'"
      />

      <div class={isVertical ? '' : 'flex-1 min-w-0'}>
        {/* Display Name & Username */}
        <div class={isVertical ? 'mb-2' : ''}>
          {displayName && (
            <h2 class={`font-bold text-text ${isVertical ? 'text-lg' : 'text-xl'}`}>
              {displayName}
            </h2>
          )}
          <p class={`text-text-muted ${displayName ? 'text-sm' : 'text-lg font-semibold'}`}>
            @{username}
          </p>
        </div>

        {/* Reputation Badge */}
        {showReputation && reputation !== undefined && (
          <span class="inline-block px-2 py-0.5 text-xs font-medium bg-primary/10 text-primary rounded-full mt-1">
            Rep: {reputation.toFixed(0)}
          </span>
        )}

        {/* About/Bio */}
        {showAbout && about && (
          <p class={`text-text-muted text-sm mt-2 ${isVertical ? '' : 'line-clamp-2'}`}>
            {about}
          </p>
        )}

        {/* Location & Website */}
        {(showLocation && location) || (showWebsite && website) ? (
          <div class={`flex flex-wrap gap-3 text-sm text-text-muted mt-2 ${isVertical ? 'justify-center' : ''}`}>
            {showLocation && location && (
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                {location}
              </span>
            )}
            {showWebsite && website && (
              <a
                href={website.startsWith('http') ? website : `https://${website}`}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1 hover:text-primary transition-colors"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
                {website.replace(/^https?:\/\//, '').replace(/\/$/, '')}
              </a>
            )}
          </div>
        ) : null}

        {/* Join Date */}
        {showJoinDate && joinDate && (
          <p class={`text-xs text-text-muted mt-2 ${isVertical ? '' : ''}`}>
            <span class="inline-flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              Joined {formatDate(joinDate)}
            </span>
          </p>
        )}
      </div>
    </div>

    {/* Stats Grid */}
    <div class={`grid gap-3 mt-4 pt-4 border-t border-border ${isVertical ? 'grid-cols-2' : 'grid-cols-3 md:grid-cols-4'}`}>
      {showFollowers && followers !== undefined && (
        <div class={isVertical ? 'text-center' : ''}>
          <p class="text-lg font-bold text-text">{formatNumber(followers)}</p>
          <p class="text-xs text-text-muted">Followers</p>
        </div>
      )}
      {showFollowing && following !== undefined && (
        <div class={isVertical ? 'text-center' : ''}>
          <p class="text-lg font-bold text-text">{formatNumber(following)}</p>
          <p class="text-xs text-text-muted">Following</p>
        </div>
      )}
      {showPostCount && (
        <div class={isVertical ? 'text-center' : ''}>
          <p class="text-lg font-bold text-text">{formatNumber(postCount)}</p>
          <p class="text-xs text-text-muted">Posts</p>
        </div>
      )}
      {showRewards && (
        <div class={isVertical ? 'text-center' : ''}>
          <p class="text-lg font-bold text-success">{formatNumber(Math.round(hpEarned))}</p>
          <p class="text-xs text-text-muted">HP Earned</p>
        </div>
      )}
    </div>

    {/* Financial Stats (optional) */}
    {(showVotingPower || showHiveBalance || showHbdBalance || showHivePower) && (
      <div class={`grid gap-3 mt-3 pt-3 border-t border-border/50 ${isVertical ? 'grid-cols-2' : 'grid-cols-3'}`}>
        {showHivePower && (
          <div class={isVertical ? 'text-center' : ''}>
            <p class="text-sm font-semibold text-text">{hivePower.toFixed(3)}</p>
            <p class="text-xs text-text-muted">Hive Power</p>
          </div>
        )}
        {showVotingPower && (
          <div class={isVertical ? 'text-center' : ''}>
            <p class="text-sm font-semibold text-text">{votingPower.toFixed(1)}%</p>
            <p class="text-xs text-text-muted">Voting Power</p>
          </div>
        )}
        {showHiveBalance && (
          <div class={isVertical ? 'text-center' : ''}>
            <p class="text-sm font-semibold text-text">{hiveBalance.toFixed(3)}</p>
            <p class="text-xs text-text-muted">HIVE</p>
          </div>
        )}
        {showHbdBalance && (
          <div class={isVertical ? 'text-center' : ''}>
            <p class="text-sm font-semibold text-text">{hbdBalance.toFixed(3)}</p>
            <p class="text-xs text-text-muted">HBD</p>
          </div>
        )}
      </div>
    )}
  </div>
</div>
