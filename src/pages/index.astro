---
import Layout from '../layouts/Layout.astro'
import { loadConfigFromHive } from '../components/admin/hive-broadcast'
import { HIVE_USERNAME } from '../lib/config'

// Blog Logic imports - all data goes through blog-logic
import {
  DataProvider,
  getWax,
  Post,
  type IAccountManabars,
  type IProfile,
  type IDatabaseAccount,
  type IGlobalProperties,
  type AccountPostsSortOption,
  type CommentSortOption,
  type IPaginationCursor,
  type BridgeComment,
} from '../lib/blog-logic'

// TanStack Query imports for SSR prefetching
import { dehydrate } from '@tanstack/solid-query'
import { create_query_client, query_keys, fetch_profile, fetch_database_account, fetch_global_properties, fetch_manabars, fetch_posts, fetch_comments, type FetchPostsResult, type FetchCommentsResult } from '../lib/queries'
import { BlogContent } from '../components/home/BlogContent'

import SlotRenderer from '../components/home/SlotRenderer.astro'
import { type SiteSettings, type PageLayout, type PageSlotPosition, defaultPageLayout } from '../components/home/types'

// ============================================
// Data fetching with TanStack Query
// ============================================

// Create per-request QueryClient (NEVER global on server)
const query_client = create_query_client()

// Get URL for parsing query params
const url = new URL(Astro.request.url)

let blogLogicPosts: Post[] = []
let hiveComments: readonly BridgeComment[] = []
let hiveAccount: IDatabaseAccount | null = null
let hiveProfile: IProfile | null = null
let globalProperties: IGlobalProperties | null = null
let accountManabars: IAccountManabars | null = null
let settings: SiteSettings = {}
let error: string | null = null
let hasMorePosts = false
let hasMoreComments = false
let totalFetchedBeforeFilter = 0
let nextPostsCursor: IPaginationCursor | undefined
let nextCommentsCursor: IPaginationCursor | undefined
let dehydrated_state = null

// Get hive username from env variable first (this is the blog owner)
// import.meta.env works in dev, process.env works in production SSR
const hiveUsername = import.meta.env.HIVE_USERNAME || process.env.HIVE_USERNAME

// Load settings from Hive blockchain for this user
if (hiveUsername) {
  try {
    const hiveConfig = await loadConfigFromHive(hiveUsername)
    if (hiveConfig) {
      settings = hiveConfig as SiteSettings
    }
  } catch (e) {
    console.error('Failed to load config from Hive:', e)
  }
}

// ============================================
// Tab handling - use navigationTabs from settings
// ============================================

// Check if comments tab is enabled in navigationTabs
const commentsTabConfig = settings.navigationTabs?.find(tab => tab.id === 'comments')
const showCommentsTab = commentsTabConfig?.enabled !== false

const requestedTab = url.searchParams.get('tab') || 'posts'

// Validate tab ID against known tabs - unknown tabs fall back to 'posts'
// Include 'comments' as fallback even when navigationTabs is undefined
const knownTabIds = ['posts', 'comments', ...(settings.navigationTabs?.map(t => t.id) || [])]
const validatedTab = knownTabIds.includes(requestedTab) ? requestedTab : 'posts'

// If comments tab is disabled but user requested it, fall back to posts
const activeTab = (validatedTab === 'comments' && !showCommentsTab) ? 'posts' : validatedTab

// Check if active tab is a category tab (has tag for filtering)
const activeCategoryTab = settings.navigationTabs?.find(tab => tab.id === activeTab && tab.tag)
const activeCategoryTag = activeCategoryTab?.tag || null

// ============================================
// Pagination cursor from URL
// ============================================

const startAuthor = url.searchParams.get('start_author') || undefined
const startPermlink = url.searchParams.get('start_permlink') || undefined
const cursor: IPaginationCursor | undefined = (startAuthor && startPermlink)
  ? { startAuthor, startPermlink }
  : undefined

// ============================================
// Fetch Hive data (all through blog-logic)
// ============================================

/**
 * Wraps a promise with a timeout to prevent indefinite waiting
 * @param promise - The promise to wrap
 * @param ms - Timeout in milliseconds
 * @returns Promise that rejects if timeout is exceeded
 */
function withTimeout<T>(promise: Promise<T>, ms: number): Promise<T> {
  return Promise.race([
    promise,
    new Promise<T>((_, reject) => setTimeout(() => reject(new Error(`Timeout after ${ms}ms`)), ms))
  ])
}

const postsLimit = settings.postsPerPage || 20
const postsSortOrder: AccountPostsSortOption = settings.postsSortOrder || 'blog'
const commentsSortOrder: CommentSortOption = settings.commentsSortOrder || 'comments'

try {

  if (hiveUsername) {
    // Prefetch data using TanStack Query
    await Promise.allSettled([
      query_client.prefetchQuery({
        queryKey: query_keys.profile(hiveUsername),
        queryFn: () => fetch_profile(hiveUsername),
      }),
      query_client.prefetchQuery({
        queryKey: query_keys.database_account(hiveUsername),
        queryFn: () => fetch_database_account(hiveUsername),
      }),
      query_client.prefetchQuery({
        queryKey: query_keys.global_properties(),
        queryFn: () => fetch_global_properties(),
      }),
      query_client.prefetchQuery({
        queryKey: query_keys.manabars(hiveUsername),
        queryFn: () => fetch_manabars(hiveUsername),
      }),
    ])

    // Get cached data for SSR rendering
    hiveProfile = query_client.getQueryData(query_keys.profile(hiveUsername)) ?? null
    hiveAccount = query_client.getQueryData(query_keys.database_account(hiveUsername)) ?? null
    globalProperties = query_client.getQueryData(query_keys.global_properties()) ?? null
    accountManabars = query_client.getQueryData(query_keys.manabars(hiveUsername)) ?? null

    // Prefetch content based on active tab
    if (activeTab === 'comments' && showCommentsTab) {
      await query_client.prefetchQuery({
        queryKey: query_keys.comments(hiveUsername, commentsSortOrder, postsLimit, cursor),
        queryFn: () => fetch_comments(hiveUsername, commentsSortOrder, postsLimit, cursor),
      })

      const comments_data = query_client.getQueryData<FetchCommentsResult>(query_keys.comments(hiveUsername, commentsSortOrder, postsLimit, cursor))
      if (comments_data) {
        hiveComments = comments_data.comments
        hasMoreComments = comments_data.has_more
        nextCommentsCursor = comments_data.next_cursor
      }
    } else {
      await query_client.prefetchQuery({
        queryKey: query_keys.posts(hiveUsername, postsSortOrder, postsLimit, cursor, activeCategoryTag),
        queryFn: () => fetch_posts(hiveUsername, postsSortOrder, postsLimit, cursor, activeCategoryTag),
      })

      const posts_data = query_client.getQueryData<FetchPostsResult>(query_keys.posts(hiveUsername, postsSortOrder, postsLimit, cursor, activeCategoryTag))
      if (posts_data) {
        blogLogicPosts = posts_data.posts
        hasMorePosts = posts_data.has_more
        nextPostsCursor = posts_data.next_cursor
        totalFetchedBeforeFilter = posts_data.posts.length
      }
    }

    // Dehydrate state for client-side hydration
    dehydrated_state = dehydrate(query_client)
  }
} catch (e) {
  console.error('Error fetching Hive data:', e)
  error = 'Error fetching data from Hive blockchain.'
}

// ============================================
// Settings with defaults
// ============================================

const defaultSiteName = HIVE_USERNAME ? `${HIVE_USERNAME} Blog` : 'Hive Blog'
const siteName = settings.siteName || defaultSiteName
const siteDescription = settings.siteDescription || 'Posts from Hive blockchain'

// Use new pageLayout format, fallback to default
const pageLayout: PageLayout = settings.pageLayout?.sections?.length
  ? settings.pageLayout
  : defaultPageLayout

// Group sections by slot position
const sectionsBySlot: Record<PageSlotPosition, typeof pageLayout.sections> = {
  top: [],
  'sidebar-left': [],
  main: [],
  'sidebar-right': [],
  bottom: [],
}
pageLayout.sections.forEach(section => {
  if (sectionsBySlot[section.slot]) {
    sectionsBySlot[section.slot].push(section)
  }
})

// Helper: Get all elements in a slot (with null safety)
function getElementsInSlot(slot: PageSlotPosition): string[] {
  const sections = sectionsBySlot[slot]
  if (!sections || !Array.isArray(sections)) return []
  return sections.flatMap(section => section.elements || [])
}

// Helper: Check if element exists in a slot
function hasElementInSlot(slot: PageSlotPosition, elementId: string): boolean {
  return getElementsInSlot(slot).includes(elementId)
}

const hasLeftSidebar = getElementsInSlot('sidebar-left').length > 0
const hasRightSidebar = getElementsInSlot('sidebar-right').length > 0
const hasSidebars = hasLeftSidebar || hasRightSidebar

const showHeader = settings.showHeader !== false
const showAuthorProfile = settings.showAuthorProfile !== false
const authorAvatarSizePx = settings.authorAvatarSizePx ?? 64
const sidebarWidthPx = settings.sidebarWidthPx || 280

// Size settings for Author Profile
const authorCoverHeight = settings.authorCoverHeightPx ?? 64
const authorUsernameSize = settings.authorUsernameSizePx ?? 14
const authorDisplayNameSize = settings.authorDisplayNameSizePx ?? 18
const authorAboutSize = settings.authorAboutSizePx ?? 14
const authorStatsSize = settings.authorStatsSizePx ?? 14
const authorMetaSize = settings.authorMetaSizePx ?? 12

// Shared props for AuthorProfile to reduce duplication
const authorProfileBaseProps = {
  username: hiveUsername,
  account: hiveAccount,
  profile: hiveProfile,
  globalProperties: globalProperties,
  accountManabars: accountManabars,
  // Layout from settings (uses CardLayout format)
  profileLayout: settings.authorProfileLayout2,
  // Size settings
  avatarSize: authorAvatarSizePx,
  coverHeight: authorCoverHeight,
  usernameSize: authorUsernameSize,
  displayNameSize: authorDisplayNameSize,
  aboutSize: authorAboutSize,
  statsSize: authorStatsSize,
  metaSize: authorMetaSize,
  // Social links
  socialLinks: settings.socialLinks || [],
}

// ============================================
// Pagination URL helpers
// ============================================

function buildNextPageUrl(tab: string, nextCursor: IPaginationCursor | undefined): string | null {
  if (!nextCursor?.startAuthor || !nextCursor?.startPermlink) return null

  const nextUrl = new URL(url)
  nextUrl.searchParams.set('tab', tab)
  nextUrl.searchParams.set('start_author', nextCursor.startAuthor)
  nextUrl.searchParams.set('start_permlink', nextCursor.startPermlink)
  return nextUrl.pathname + nextUrl.search
}

const nextPostsPageUrl = buildNextPageUrl('posts', nextPostsCursor)
const nextCommentsPageUrl = buildNextPageUrl('comments', nextCommentsCursor)
const isFirstPage = !cursor

const isCategory = !!activeCategoryTag
// Show warning when category filter may hide matching posts beyond the API fetch limit
const showCategoryLimitWarning = isCategory && totalFetchedBeforeFilter >= (settings.postsPerPage || 20)

// Common props for SlotRenderer
const slotRendererProps = {
  siteName,
  siteDescription,
  showHeader,
  hiveUsername,
  hiveAccount,
  hiveProfile,
  globalProperties,
  accountManabars,
  blogLogicPosts,
  hiveComments,
  activeTab,
  showCommentsTab,
  settings,
  showAuthorProfile,
  authorProfileBaseProps,
  isCategory,
  activeCategoryTag,
  totalFetchedBeforeFilter,
  showCategoryLimitWarning,
  isFirstPage,
  hasMorePosts,
  nextPostsPageUrl,
  hasMoreComments,
  nextCommentsPageUrl,
}
---

<Layout title={siteName} settings={settings}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    {/* Top sections - render elements in order */}
    <SlotRenderer elementIds={getElementsInSlot('top')} context="top" {...slotRendererProps} />

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {!hiveUsername && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text mb-2">Hive username is not configured.</p>
        <p class="text-text-muted">Set the HIVE_USERNAME environment variable in .env file</p>
      </div>
    )}

    {/* Main content with optional sidebars - Responsive Layout */}
    {hasSidebars ? (
      <div class="sidebar-layout">
        {/* Left Sidebar - Mobile: above main content | Desktop: left side with fixed width */}
        {hasLeftSidebar && (
          <aside class="sidebar-left" style={`--sidebar-width: ${sidebarWidthPx}px;`}>
            <SlotRenderer elementIds={getElementsInSlot('sidebar-left')} context="sidebar-left" {...slotRendererProps} />
          </aside>
        )}

        {/* Main Content - always in the center */}
        <main class="main-content">
          {/* Progressive enhancement: Use SolidJS island for interactive content with TanStack Query */}
          {/* Falls back to SSR content if JS is disabled */}
          {hiveUsername && dehydrated_state && (
            <>
              <noscript>
                {/* Static fallback for no-JS - render posts directly without interactive components */}
                {activeTab !== 'comments' && blogLogicPosts.length > 0 && (
                  <div class="flex flex-col gap-4">
                    {blogLogicPosts.map((post) => (
                      <article class="bg-bg-card border border-border p-6 rounded-2xl">
                        <h2 class="font-bold text-text mb-2 text-xl">
                          <a href={`/posts/${post.permlink}`} class="hover:text-primary transition-colors">
                            {post.title}
                          </a>
                        </h2>
                        <div class="text-text-muted text-sm">
                          by {post.author} • {post.publishedAt.toLocaleDateString()}
                        </div>
                      </article>
                    ))}
                  </div>
                )}
                {activeTab === 'comments' && hiveComments.length > 0 && (
                  <div class="flex flex-col gap-4">
                    {hiveComments.map((comment) => (
                      <article class="bg-bg-card border border-border p-4 rounded-xl">
                        <div class="text-text-muted text-sm mb-2">
                          @{comment.author} • {new Date(comment.created).toLocaleDateString()}
                        </div>
                        <div class="text-text">{comment.body?.substring(0, 200)}...</div>
                      </article>
                    ))}
                  </div>
                )}
              </noscript>
              <div class="js-only">
                <BlogContent
                  client:only="solid-js"
                  hive_username={hiveUsername}
                  initial_tab={activeTab}
                  show_comments_tab={showCommentsTab}
                  posts_sort_order={postsSortOrder}
                  comments_sort_order={commentsSortOrder}
                  posts_per_page={postsLimit}
                  settings={settings}
                  dehydrated_state={dehydrated_state}
                  category_tag={activeCategoryTag}
                  navigation_tabs={settings.navigationTabs}
                  post_card_layout={settings.postCardLayout}
                />
              </div>
            </>
          )}
          {(!hiveUsername || !dehydrated_state) && (
            <SlotRenderer elementIds={getElementsInSlot('main')} context="main" {...slotRendererProps} />
          )}
        </main>

        {/* Right Sidebar - Mobile: above main content (after left sidebar) | Desktop: right side */}
        {hasRightSidebar && (
          <aside class="sidebar-right" style={`--sidebar-width: ${sidebarWidthPx}px;`}>
            <SlotRenderer elementIds={getElementsInSlot('sidebar-right')} context="sidebar-right" {...slotRendererProps} />
          </aside>
        )}
      </div>
    ) : (
      /* No sidebars - render main content directly */
      <>
        {hiveUsername && dehydrated_state && (
          <>
            <noscript>
              {/* Static fallback for no-JS - render posts directly without interactive components */}
              {activeTab !== 'comments' && blogLogicPosts.length > 0 && (
                <div class="flex flex-col gap-4">
                  {blogLogicPosts.map((post) => (
                    <article class="bg-bg-card border border-border p-6 rounded-2xl">
                      <h2 class="font-bold text-text mb-2 text-xl">
                        <a href={`/posts/${post.permlink}`} class="hover:text-primary transition-colors">
                          {post.title}
                        </a>
                      </h2>
                      <div class="text-text-muted text-sm">
                        by {post.author} • {post.publishedAt.toLocaleDateString()}
                      </div>
                    </article>
                  ))}
                </div>
              )}
              {activeTab === 'comments' && hiveComments.length > 0 && (
                <div class="flex flex-col gap-4">
                  {hiveComments.map((comment) => (
                    <article class="bg-bg-card border border-border p-4 rounded-xl">
                      <div class="text-text-muted text-sm mb-2">
                        @{comment.author} • {new Date(comment.created).toLocaleDateString()}
                      </div>
                      <div class="text-text">{comment.body?.substring(0, 200)}...</div>
                    </article>
                  ))}
                </div>
              )}
            </noscript>
            <div class="js-only">
              <BlogContent
                client:only="solid-js"
                hive_username={hiveUsername}
                initial_tab={activeTab}
                show_comments_tab={showCommentsTab}
                posts_sort_order={postsSortOrder}
                comments_sort_order={commentsSortOrder}
                posts_per_page={postsLimit}
                settings={settings}
                dehydrated_state={dehydrated_state}
                category_tag={activeCategoryTag}
                navigation_tabs={settings.navigationTabs}
                post_card_layout={settings.postCardLayout}
              />
            </div>
          </>
        )}
        {(!hiveUsername || !dehydrated_state) && (
          <SlotRenderer elementIds={getElementsInSlot('main')} context="main" {...slotRendererProps} />
        )}
      </>
    )}

    {/* Bottom sections - render elements in order */}
    <SlotRenderer elementIds={getElementsInSlot('bottom')} context="bottom" {...slotRendererProps} />
  </div>
</Layout>
