---
import Layout from '../layouts/Layout.astro'
import {
  getHiveBlogPosts,
  getHiveAccount,
  getHiveProfile,
  getHiveUserComments,
  type BridgePost,
  type DatabaseAccount,
  type BridgeProfile,
} from '../lib/hive'
import { getPayloadClient } from '../lib/payload'

import Header from '../components/home/Header.astro'
import AuthorProfile from '../components/home/AuthorProfile.astro'
import PostsGrid from '../components/home/PostsGrid.astro'
import Footer from '../components/home/Footer.astro'
import ContentTabs from '../components/home/ContentTabs.astro'
import CommentCard from '../components/home/CommentCard.astro'
import { type SiteSettings, type LayoutSection, defaultLayoutSections } from '../components/home/types'

// ============================================
// Data fetching
// ============================================

// Get URL for parsing query params
const url = new URL(Astro.request.url)

let hivePosts: readonly BridgePost[] = []
let hiveComments: readonly BridgePost[] = []
let hiveAccount: DatabaseAccount | null = null
let hiveProfile: BridgeProfile | null = null
let settings: SiteSettings = {}
let error: string | null = null
let isDemoMode = false

// Try to load settings from MongoDB, fallback to localStorage data from cookie
try {
  const payload = await getPayloadClient()
  settings = await payload.findGlobal({ slug: 'settings' }) as SiteSettings
} catch (e) {
  console.warn('MongoDB unavailable, using default settings (demo mode)')
  isDemoMode = true

  // In demo mode, try to read settings from cookie (set by client-side localStorage sync)
  const settingsCookie = Astro.cookies.get('hive-blog-settings')
  if (settingsCookie) {
    try {
      // Cookie value is URL encoded
      const decoded = decodeURIComponent(settingsCookie.value)
      settings = JSON.parse(decoded)
    } catch {
      // Invalid cookie, use defaults
    }
  }
}

// Determine hive username from settings, fallback to env variable
const hiveUsername = settings.hiveUsername || import.meta.env.HIVE_USERNAME

// ============================================
// Tab handling
// ============================================

const showCommentsTab = settings.showCommentsTab !== false
const requestedTab = url.searchParams.get('tab') || 'posts'
// If comments tab is disabled but user requested it, fall back to posts
const activeTab = (requestedTab === 'comments' && !showCommentsTab) ? 'posts' : requestedTab

// Tab configuration
const tabs = [
  { id: 'posts', label: 'Posts', count: hiveProfile?.post_count },
  ...(showCommentsTab ? [{ id: 'comments', label: 'Comments' }] : []),
]

// ============================================
// Fetch Hive data
// ============================================

try {
  const postsLimit = settings.postsPerPage || 20

  if (hiveUsername) {
    // Fetch account and profile always
    [hiveAccount, hiveProfile] = await Promise.all([
      getHiveAccount(hiveUsername),
      getHiveProfile(hiveUsername),
    ])

    // Fetch content based on active tab
    if (activeTab === 'comments' && showCommentsTab) {
      hiveComments = await getHiveUserComments(hiveUsername, postsLimit)
    } else {
      hivePosts = await getHiveBlogPosts(hiveUsername, postsLimit)
    }
  }
} catch (e) {
  console.error('Error fetching Hive data:', e)
  error = 'Error fetching data from Hive blockchain.'
}

// ============================================
// Settings with defaults
// ============================================

const siteName = settings.siteName || 'Hive Blog'
const siteDescription = settings.siteDescription || 'Posts from Hive blockchain'

const layoutSections = settings.layoutSections || defaultLayoutSections
const sectionsByPosition: Record<string, LayoutSection[]> = {
  top: [],
  'sidebar-left': [],
  main: [],
  'sidebar-right': [],
  bottom: [],
}
layoutSections.filter(s => s.enabled).forEach(s => {
  sectionsByPosition[s.position].push(s)
})

const hasLeftSidebar = sectionsByPosition['sidebar-left'].length > 0
const hasRightSidebar = sectionsByPosition['sidebar-right'].length > 0
const hasSidebars = hasLeftSidebar || hasRightSidebar

const showHeader = settings.showHeader !== false
const showAuthorProfile = settings.showAuthorProfile !== false
const authorAvatarSizePx = settings.authorAvatarSizePx ?? 64
const showPostCount = settings.showPostCount !== false
const showAuthorRewards = settings.showAuthorRewards !== false
const sidebarWidthPx = settings.sidebarWidthPx || 280

// Author Profile extended settings
const authorProfileLayout = settings.authorProfileLayout || 'horizontal'
const showAuthorAbout = settings.showAuthorAbout !== false
const showAuthorLocation = settings.showAuthorLocation !== false
const showAuthorWebsite = settings.showAuthorWebsite !== false
const showAuthorJoinDate = settings.showAuthorJoinDate !== false
const showAuthorReputation = settings.showAuthorReputation !== false
const showAuthorFollowers = settings.showAuthorFollowers !== false
const showAuthorFollowing = settings.showAuthorFollowing !== false
const showAuthorVotingPower = settings.showAuthorVotingPower ?? false
const showAuthorHiveBalance = settings.showAuthorHiveBalance ?? false
const showAuthorHbdBalance = settings.showAuthorHbdBalance ?? false
const showAuthorCoverImage = settings.showAuthorCoverImage !== false

// ============================================
// Helper: Render section content
// ============================================

function hasSection(position: string, sectionId: string): boolean {
  return sectionsByPosition[position].some(s => s.id === sectionId)
}
---

<Layout title={siteName}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    {/* Top sections */}
    {sectionsByPosition.top.map(section => (
      <>
        {section.id === 'header' && showHeader && (
          <Header siteName={siteName} siteDescription={siteDescription} />
        )}
        {section.id === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
          <div class="mb-8">
            <AuthorProfile
              username={hiveUsername}
              account={hiveAccount}
              profile={hiveProfile}
              avatarSize={authorAvatarSizePx}
              showPostCount={showPostCount}
              showRewards={showAuthorRewards}
              layout={authorProfileLayout}
              showAbout={showAuthorAbout}
              showLocation={showAuthorLocation}
              showWebsite={showAuthorWebsite}
              showJoinDate={showAuthorJoinDate}
              showReputation={showAuthorReputation}
              showFollowers={showAuthorFollowers}
              showFollowing={showAuthorFollowing}
              showVotingPower={showAuthorVotingPower}
              showHiveBalance={showAuthorHiveBalance}
              showHbdBalance={showAuthorHbdBalance}
              showCoverImage={showAuthorCoverImage}
            />
          </div>
        )}
        {section.id === 'footer' && (
          <Footer class="mb-8" />
        )}
      </>
    ))}

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {!hiveUsername && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text mb-2">Hive username is not configured.</p>
        <p class="text-text-muted">Set the HIVE_USERNAME environment variable in .env file</p>
      </div>
    )}

    {/* Main content with optional sidebars */}
    {hasSidebars ? (
      <div class="flex gap-8">
        {/* Left Sidebar */}
        {hasLeftSidebar && (
          <aside style={`width: ${sidebarWidthPx}px; flex-shrink: 0;`}>
            {hasSection('sidebar-left', 'header') && showHeader && (
              <div class="mb-6 pb-4 border-b border-border">
                <h1 class="text-2xl font-bold text-text">{siteName}</h1>
                <p class="text-text-muted mt-1 text-sm">{siteDescription}</p>
              </div>
            )}
            {hasSection('sidebar-left', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
              <div class="mb-6">
                <AuthorProfile
                  username={hiveUsername}
                  account={hiveAccount}
                  profile={hiveProfile}
                  avatarSize={authorAvatarSizePx}
                  showPostCount={showPostCount}
                  showRewards={showAuthorRewards}
                  layout="vertical"
                  showAbout={showAuthorAbout}
                  showLocation={showAuthorLocation}
                  showWebsite={showAuthorWebsite}
                  showJoinDate={showAuthorJoinDate}
                  showReputation={showAuthorReputation}
                  showFollowers={showAuthorFollowers}
                  showFollowing={showAuthorFollowing}
                  showVotingPower={showAuthorVotingPower}
                  showHiveBalance={showAuthorHiveBalance}
                  showHbdBalance={showAuthorHbdBalance}
                  showCoverImage={showAuthorCoverImage}
                />
              </div>
            )}
          </aside>
        )}

        {/* Main Content */}
        <main class="flex-1 min-w-0">
          {hasSection('main', 'header') && showHeader && (
            <Header siteName={siteName} siteDescription={siteDescription} />
          )}
          {hasSection('main', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
            <div class="mb-8">
              <AuthorProfile
                username={hiveUsername}
                account={hiveAccount}
                profile={hiveProfile}
                avatarSize={authorAvatarSizePx}
                showPostCount={showPostCount}
                showRewards={showAuthorRewards}
                layout={authorProfileLayout}
                showAbout={showAuthorAbout}
                showLocation={showAuthorLocation}
                showWebsite={showAuthorWebsite}
                showJoinDate={showAuthorJoinDate}
                showReputation={showAuthorReputation}
                showFollowers={showAuthorFollowers}
                showFollowing={showAuthorFollowing}
                showVotingPower={showAuthorVotingPower}
                showHiveBalance={showAuthorHiveBalance}
                showHbdBalance={showAuthorHbdBalance}
                showCoverImage={showAuthorCoverImage}
              />
            </div>
          )}
          {hasSection('main', 'posts') && hiveUsername && (
            <>
              {tabs.length > 1 && <ContentTabs tabs={tabs} activeTab={activeTab} />}

              {activeTab === 'posts' ? (
                <>
                  {hivePosts.length > 0 ? (
                    <PostsGrid posts={hivePosts} settings={settings} />
                  ) : (
                    <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                      <p class="text-text">No posts found for @{hiveUsername}</p>
                    </div>
                  )}
                </>
              ) : (
                <>
                  {hiveComments.length > 0 ? (
                    settings.commentsLayout === 'list' ? (
                      <div class="divide-y divide-border bg-bg-card rounded-xl shadow-sm border border-border overflow-hidden">
                        {hiveComments.map(comment => (
                          <CommentCard comment={comment} settings={settings} layout="list" />
                        ))}
                      </div>
                    ) : settings.commentsLayout === 'masonry' ? (
                      <div
                        style={`column-count: ${settings.commentsGridColumns || 2}; column-gap: ${settings.commentsGapPx || 16}px;`}
                      >
                        {hiveComments.map(comment => (
                          <div class="break-inside-avoid" style={`margin-bottom: ${settings.commentsGapPx || 16}px;`}>
                            <CommentCard comment={comment} settings={settings} layout="masonry" />
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div
                        style={`display: grid; grid-template-columns: repeat(${settings.commentsGridColumns || 2}, 1fr); gap: ${settings.commentsGapPx || 16}px;`}
                      >
                        {hiveComments.map(comment => (
                          <CommentCard comment={comment} settings={settings} layout="grid" />
                        ))}
                      </div>
                    )
                  ) : (
                    <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                      <p class="text-text">No comments found for @{hiveUsername}</p>
                    </div>
                  )}
                </>
              )}
            </>
          )}
        </main>

        {/* Right Sidebar */}
        {hasRightSidebar && (
          <aside style={`width: ${sidebarWidthPx}px; flex-shrink: 0;`}>
            {hasSection('sidebar-right', 'header') && showHeader && (
              <div class="mb-6 pb-4 border-b border-border">
                <h1 class="text-2xl font-bold text-text">{siteName}</h1>
                <p class="text-text-muted mt-1 text-sm">{siteDescription}</p>
              </div>
            )}
            {hasSection('sidebar-right', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
              <div class="mb-6">
                <AuthorProfile
                  username={hiveUsername}
                  account={hiveAccount}
                  profile={hiveProfile}
                  avatarSize={authorAvatarSizePx}
                  showPostCount={showPostCount}
                  showRewards={showAuthorRewards}
                  layout="vertical"
                  showAbout={showAuthorAbout}
                  showLocation={showAuthorLocation}
                  showWebsite={showAuthorWebsite}
                  showJoinDate={showAuthorJoinDate}
                  showReputation={showAuthorReputation}
                  showFollowers={showAuthorFollowers}
                  showFollowing={showAuthorFollowing}
                  showVotingPower={showAuthorVotingPower}
                  showHiveBalance={showAuthorHiveBalance}
                  showHbdBalance={showAuthorHbdBalance}
                  showCoverImage={showAuthorCoverImage}
                />
              </div>
            )}
          </aside>
        )}
      </div>
    ) : (
      /* No sidebars - render main content directly */
      <>
        {hasSection('main', 'header') && showHeader && (
          <Header siteName={siteName} siteDescription={siteDescription} />
        )}
        {hasSection('main', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
          <div class="mb-8">
            <AuthorProfile
              username={hiveUsername}
              account={hiveAccount}
              profile={hiveProfile}
              avatarSize={authorAvatarSizePx}
              showPostCount={showPostCount}
              showRewards={showAuthorRewards}
              layout={authorProfileLayout}
              showAbout={showAuthorAbout}
              showLocation={showAuthorLocation}
              showWebsite={showAuthorWebsite}
              showJoinDate={showAuthorJoinDate}
              showReputation={showAuthorReputation}
              showFollowers={showAuthorFollowers}
              showFollowing={showAuthorFollowing}
              showVotingPower={showAuthorVotingPower}
              showHiveBalance={showAuthorHiveBalance}
              showHbdBalance={showAuthorHbdBalance}
              showCoverImage={showAuthorCoverImage}
            />
          </div>
        )}
        {hasSection('main', 'posts') && hiveUsername && (
          <>
            {tabs.length > 1 && <ContentTabs tabs={tabs} activeTab={activeTab} />}

            {activeTab === 'posts' ? (
              <>
                {hivePosts.length > 0 ? (
                  <PostsGrid posts={hivePosts} settings={settings} />
                ) : (
                  <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                    <p class="text-text">No posts found for @{hiveUsername}</p>
                  </div>
                )}
              </>
            ) : (
              <>
                {hiveComments.length > 0 ? (
                  settings.commentsLayout === 'list' ? (
                    <div class="divide-y divide-border bg-bg-card rounded-xl shadow-sm border border-border overflow-hidden">
                      {hiveComments.map(comment => (
                        <CommentCard comment={comment} settings={settings} layout="list" />
                      ))}
                    </div>
                  ) : settings.commentsLayout === 'masonry' ? (
                    <div
                      style={`column-count: ${settings.commentsGridColumns || 2}; column-gap: ${settings.commentsGapPx || 16}px;`}
                    >
                      {hiveComments.map(comment => (
                        <div class="break-inside-avoid" style={`margin-bottom: ${settings.commentsGapPx || 16}px;`}>
                          <CommentCard comment={comment} settings={settings} layout="masonry" />
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div
                      style={`display: grid; grid-template-columns: repeat(${settings.commentsGridColumns || 2}, 1fr); gap: ${settings.commentsGapPx || 16}px;`}
                    >
                      {hiveComments.map(comment => (
                        <CommentCard comment={comment} settings={settings} layout="grid" />
                      ))}
                    </div>
                  )
                ) : (
                  <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                    <p class="text-text">No comments found for @{hiveUsername}</p>
                  </div>
                )}
              </>
            )}
          </>
        )}
      </>
    )}

    {/* Bottom sections */}
    {sectionsByPosition.bottom.map(section => (
      <>
        {section.id === 'header' && showHeader && (
          <div class="mt-8 pt-4 border-t border-border">
            <h1 class="text-2xl font-bold text-text">{siteName}</h1>
            <p class="text-text-muted mt-1">{siteDescription}</p>
          </div>
        )}
        {section.id === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
          <div class="mt-8">
            <AuthorProfile
              username={hiveUsername}
              account={hiveAccount}
              profile={hiveProfile}
              avatarSize={authorAvatarSizePx}
              showPostCount={showPostCount}
              showRewards={showAuthorRewards}
              layout={authorProfileLayout}
              showAbout={showAuthorAbout}
              showLocation={showAuthorLocation}
              showWebsite={showAuthorWebsite}
              showJoinDate={showAuthorJoinDate}
              showReputation={showAuthorReputation}
              showFollowers={showAuthorFollowers}
              showFollowing={showAuthorFollowing}
              showVotingPower={showAuthorVotingPower}
              showHiveBalance={showAuthorHiveBalance}
              showHbdBalance={showAuthorHbdBalance}
              showCoverImage={showAuthorCoverImage}
            />
          </div>
        )}
        {section.id === 'footer' && (
          <Footer class="mt-8" />
        )}
      </>
    ))}
  </div>
</Layout>
