---
import Layout from '../layouts/Layout.astro'
import {
  getHiveBlogPosts,
  getHiveAccount,
  type BridgePost,
  type DatabaseAccount,
} from '../lib/hive'
import { getPayloadClient } from '../lib/payload'

import Header from '../components/home/Header.astro'
import AuthorProfile from '../components/home/AuthorProfile.astro'
import PostsGrid from '../components/home/PostsGrid.astro'
import Footer from '../components/home/Footer.astro'
import { type SiteSettings, type LayoutSection, defaultLayoutSections } from '../components/home/types'

// ============================================
// Data fetching
// ============================================

const hiveUsername = import.meta.env.HIVE_USERNAME

let hivePosts: readonly BridgePost[] = []
let hiveAccount: DatabaseAccount | null = null
let settings: SiteSettings = {}
let error: string | null = null

try {
  const payload = await getPayloadClient()
  settings = await payload.findGlobal({ slug: 'settings' }) as SiteSettings

  const postsLimit = settings.postsPerPage || 20

  if (hiveUsername) {
    [hivePosts, hiveAccount] = await Promise.all([
      getHiveBlogPosts(hiveUsername, postsLimit),
      getHiveAccount(hiveUsername),
    ])
  }
} catch (e) {
  console.error('Error fetching Hive data:', e)
  error = 'Błąd pobierania danych z Hive blockchain.'
}

// ============================================
// Settings with defaults
// ============================================

const siteName = settings.siteName || 'Hive Blog'
const siteDescription = settings.siteDescription || 'Posty z Hive blockchain'

const layoutSections = settings.layoutSections || defaultLayoutSections
const sectionsByPosition: Record<string, LayoutSection[]> = {
  top: [],
  'sidebar-left': [],
  main: [],
  'sidebar-right': [],
  bottom: [],
}
layoutSections.filter(s => s.enabled).forEach(s => {
  sectionsByPosition[s.position].push(s)
})

const hasLeftSidebar = sectionsByPosition['sidebar-left'].length > 0
const hasRightSidebar = sectionsByPosition['sidebar-right'].length > 0
const hasSidebars = hasLeftSidebar || hasRightSidebar

const showHeader = settings.showHeader !== false
const showAuthorProfile = settings.showAuthorProfile !== false
const authorAvatarSizePx = settings.authorAvatarSizePx ?? 64
const showPostCount = settings.showPostCount !== false
const showAuthorRewards = settings.showAuthorRewards !== false
const sidebarWidthPx = settings.sidebarWidthPx || 280

// ============================================
// Helper: Render section content
// ============================================

function hasSection(position: string, sectionId: string): boolean {
  return sectionsByPosition[position].some(s => s.id === sectionId)
}
---

<Layout title={siteName}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    {/* Top sections */}
    {sectionsByPosition.top.map(section => (
      <>
        {section.id === 'header' && showHeader && (
          <Header siteName={siteName} siteDescription={siteDescription} />
        )}
        {section.id === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
          <div class="mb-8">
            <AuthorProfile
              username={hiveUsername}
              account={hiveAccount}
              avatarSize={authorAvatarSizePx}
              showPostCount={showPostCount}
              showRewards={showAuthorRewards}
            />
          </div>
        )}
        {section.id === 'footer' && (
          <Footer class="mb-8" />
        )}
      </>
    ))}

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {!hiveUsername && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text mb-2">Hive username nie jest skonfigurowany.</p>
        <p class="text-text-muted">Ustaw zmienną HIVE_USERNAME w pliku .env</p>
      </div>
    )}

    {/* Main content with optional sidebars */}
    {hasSidebars ? (
      <div class="flex gap-8">
        {/* Left Sidebar */}
        {hasLeftSidebar && (
          <aside style={`width: ${sidebarWidthPx}px; flex-shrink: 0;`}>
            {hasSection('sidebar-left', 'header') && showHeader && (
              <div class="mb-6 pb-4 border-b border-border">
                <h1 class="text-2xl font-bold text-text">{siteName}</h1>
                <p class="text-text-muted mt-1 text-sm">{siteDescription}</p>
              </div>
            )}
            {hasSection('sidebar-left', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
              <div class="mb-6">
                <AuthorProfile
                  username={hiveUsername}
                  account={hiveAccount}
                  avatarSize={authorAvatarSizePx}
                  showPostCount={showPostCount}
                  showRewards={showAuthorRewards}
                  layout="vertical"
                />
              </div>
            )}
          </aside>
        )}

        {/* Main Content */}
        <main class="flex-1 min-w-0">
          {hasSection('main', 'header') && showHeader && (
            <Header siteName={siteName} siteDescription={siteDescription} />
          )}
          {hasSection('main', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
            <div class="mb-8">
              <AuthorProfile
                username={hiveUsername}
                account={hiveAccount}
                avatarSize={authorAvatarSizePx}
                showPostCount={showPostCount}
                showRewards={showAuthorRewards}
              />
            </div>
          )}
          {hasSection('main', 'posts') && hivePosts.length > 0 && (
            <PostsGrid posts={hivePosts} settings={settings} />
          )}

          {hiveUsername && hivePosts.length === 0 && !error && (
            <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
              <p class="text-text">Brak postów dla użytkownika @{hiveUsername}</p>
            </div>
          )}
        </main>

        {/* Right Sidebar */}
        {hasRightSidebar && (
          <aside style={`width: ${sidebarWidthPx}px; flex-shrink: 0;`}>
            {hasSection('sidebar-right', 'header') && showHeader && (
              <div class="mb-6 pb-4 border-b border-border">
                <h1 class="text-2xl font-bold text-text">{siteName}</h1>
                <p class="text-text-muted mt-1 text-sm">{siteDescription}</p>
              </div>
            )}
            {hasSection('sidebar-right', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
              <div class="mb-6">
                <AuthorProfile
                  username={hiveUsername}
                  account={hiveAccount}
                  avatarSize={authorAvatarSizePx}
                  showPostCount={showPostCount}
                  showRewards={showAuthorRewards}
                  layout="vertical"
                />
              </div>
            )}
          </aside>
        )}
      </div>
    ) : (
      /* No sidebars - render main content directly */
      <>
        {hasSection('main', 'header') && showHeader && (
          <Header siteName={siteName} siteDescription={siteDescription} />
        )}
        {hasSection('main', 'authorProfile') && showAuthorProfile && hiveUsername && hiveAccount && (
          <div class="mb-8">
            <AuthorProfile
              username={hiveUsername}
              account={hiveAccount}
              avatarSize={authorAvatarSizePx}
              showPostCount={showPostCount}
              showRewards={showAuthorRewards}
            />
          </div>
        )}
        {hasSection('main', 'posts') && hivePosts.length > 0 && (
          <PostsGrid posts={hivePosts} settings={settings} />
        )}

        {hiveUsername && hivePosts.length === 0 && !error && (
          <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
            <p class="text-text">Brak postów dla użytkownika @{hiveUsername}</p>
          </div>
        )}
      </>
    )}

    {/* Bottom sections */}
    {sectionsByPosition.bottom.map(section => (
      <>
        {section.id === 'header' && showHeader && (
          <div class="mt-8 pt-4 border-t border-border">
            <h1 class="text-2xl font-bold text-text">{siteName}</h1>
            <p class="text-text-muted mt-1">{siteDescription}</p>
          </div>
        )}
        {section.id === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
          <div class="mt-8">
            <AuthorProfile
              username={hiveUsername}
              account={hiveAccount}
              avatarSize={authorAvatarSizePx}
              showPostCount={showPostCount}
              showRewards={showAuthorRewards}
            />
          </div>
        )}
        {section.id === 'footer' && (
          <Footer class="mt-8" />
        )}
      </>
    ))}
  </div>
</Layout>
