---
import Layout from '../layouts/Layout.astro'
import { getHiveBlogPosts, getHiveAccount, type HiveComment, type HiveAccount } from '../lib/hive'
import { getPayloadClient } from '../lib/payload'

interface SiteSettings {
  siteName?: string
  siteDescription?: string
}

const hiveUsername = import.meta.env.HIVE_USERNAME

let hivePosts: HiveComment[] = []
let hiveAccount: HiveAccount | null = null
let settings: SiteSettings = {}
let error: string | null = null

try {
  const payload = await getPayloadClient()
  settings = await payload.findGlobal({
    slug: 'settings',
  }) as SiteSettings

  if (hiveUsername) {
    [hivePosts, hiveAccount] = await Promise.all([
      getHiveBlogPosts(hiveUsername, 20),
      getHiveAccount(hiveUsername),
    ])
  }
} catch (e) {
  console.error('Error fetching Hive data:', e)
  error = 'Błąd pobierania danych z Hive blockchain.'
}

function parseJsonMetadata(jsonString: string): { image?: string[]; tags?: string[] } {
  try {
    return JSON.parse(jsonString)
  } catch {
    return {}
  }
}

function formatHiveAmount(amount: string): string {
  return amount.replace(' HIVE', '').replace(' HBD', '')
}

const siteName = settings.siteName || 'Hive Blog'
const siteDescription = settings.siteDescription || 'Posty z Hive blockchain'
---

<Layout title={siteName}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <header class="flex justify-between items-center mb-8 pb-4 border-b-2 border-border">
      <div>
        <h1 class="text-3xl font-bold text-text">{siteName}</h1>
        <p class="text-text-muted mt-1">{siteDescription}</p>
      </div>
      <a
        href="/admin"
        class="px-4 py-2 bg-bg-secondary text-text rounded-lg hover:bg-border transition-colors text-sm font-medium"
      >
        Admin
      </a>
    </header>

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {!hiveUsername && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text mb-2">Hive username nie jest skonfigurowany.</p>
        <p class="text-text-muted">Ustaw zmienną HIVE_USERNAME w pliku .env</p>
      </div>
    )}

    {hiveUsername && hiveAccount && (
      <div class="bg-bg-card rounded-xl p-6 mb-8 border border-border">
        <div class="flex items-center gap-4">
          <img
            src={`https://images.hive.blog/u/${hiveUsername}/avatar`}
            alt={hiveUsername}
            class="w-16 h-16 rounded-full border-2 border-border"
          />
          <div>
            <h2 class="text-xl font-semibold text-text">@{hiveUsername}</h2>
            <div class="text-text-muted text-sm space-x-4 mt-1">
              <span>{hiveAccount.post_count} postów</span>
              <span>{hiveAccount.posting_rewards} HP zarobionych</span>
            </div>
          </div>
        </div>
      </div>
    )}

    {hivePosts.length > 0 && (
      <div class="space-y-6">
        {hivePosts.map((post) => {
          const metadata = parseJsonMetadata(post.json_metadata)
          const thumbnail = metadata.image?.[0]
          const tags = metadata.tags || []

          return (
            <article class="bg-bg-card p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-border">
              <div class="flex gap-4">
                {thumbnail && (
                  <img
                    src={`https://images.hive.blog/256x512/${thumbnail}`}
                    alt=""
                    class="w-24 h-24 object-cover rounded-lg flex-shrink-0"
                  />
                )}
                <div class="flex-1 min-w-0">
                  <h2 class="text-xl font-semibold mb-2">
                    <a
                      href={`/${post.permlink}`}
                      class="text-text hover:text-primary transition-colors"
                    >
                      {post.title}
                    </a>
                  </h2>
                  <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-text-muted mb-3">
                    <span>{new Date(post.created + 'Z').toLocaleDateString('pl-PL')}</span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                      </svg>
                      {post.net_votes}
                    </span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                      </svg>
                      {post.children}
                    </span>
                    <span class="text-success font-medium">
                      ${formatHiveAmount(post.pending_payout_value)}
                    </span>
                  </div>
                  {tags.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {tags.slice(0, 5).map((tag: string) => (
                        <span class="px-2 py-0.5 text-xs bg-bg-secondary text-text-muted rounded">
                          #{tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </article>
          )
        })}
      </div>
    )}

    {hiveUsername && hivePosts.length === 0 && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text">Brak postów dla użytkownika @{hiveUsername}</p>
      </div>
    )}
  </div>
</Layout>
