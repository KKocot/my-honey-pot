---
import Layout from '../layouts/Layout.astro'
import {
  getHiveCommentsPaginated,
  getHiveAccount,
  getHiveProfile,
  getDynamicGlobalProperties,
  type BridgePost,
  type DatabaseAccount,
  type BridgeProfile,
  type DynamicGlobalProperties,
  type CommentSortOption,
  type PaginationCursor,
} from '../lib/hive'
import { loadConfigFromHive } from '../components/admin/hive-broadcast'

// Blog Logic imports
import { DataProvider, getWax, type Post, type IAccountPostsFilters, type IAccountManabars } from '../lib/blog-logic'

import Header from '../components/home/Header.astro'
import AuthorProfile from '../components/home/AuthorProfile.astro'
import BlogLogicPostsGrid from '../components/home/BlogLogicPostsGrid.astro'
import Footer from '../components/home/Footer.astro'
import ContentTabs from '../components/home/ContentTabs.astro'
import CommentCard from '../components/home/CommentCard.astro'
import { type SiteSettings, type PageLayout, type PageSlotPosition, defaultPageLayout } from '../components/home/types'

// ============================================
// Data fetching
// ============================================

// Get URL for parsing query params
const url = new URL(Astro.request.url)

let blogLogicPosts: Post[] = []
let hiveComments: readonly BridgePost[] = []
let hiveAccount: DatabaseAccount | null = null
let hiveProfile: BridgeProfile | null = null
let globalProperties: DynamicGlobalProperties | null = null
let accountManabars: IAccountManabars | null = null
let settings: SiteSettings = {}
let error: string | null = null
let hasMorePosts = false
let hasMoreComments = false
let nextPostsCursor: PaginationCursor | undefined
let nextCommentsCursor: PaginationCursor | undefined

// Get hive username from env variable first (this is the blog owner)
const hiveUsername = import.meta.env.HIVE_USERNAME

// Load settings from Hive blockchain for this user
if (hiveUsername) {
  try {
    console.log(`Loading blog config from Hive for @${hiveUsername}...`)
    const hiveConfig = await loadConfigFromHive(hiveUsername)
    if (hiveConfig) {
      console.log('Loaded config from Hive!')
      settings = hiveConfig as SiteSettings
    } else {
      console.log('No config found on Hive, using defaults')
    }
  } catch (e) {
    console.warn('Failed to load config from Hive:', e)
  }
}

// ============================================
// Tab handling
// ============================================

const showCommentsTab = settings.showCommentsTab !== false
const requestedTab = url.searchParams.get('tab') || 'posts'
// If comments tab is disabled but user requested it, fall back to posts
const activeTab = (requestedTab === 'comments' && !showCommentsTab) ? 'posts' : requestedTab

// Tab configuration
const tabs = [
  { id: 'posts', label: 'Posts', count: hiveProfile?.post_count },
  ...(showCommentsTab ? [{ id: 'comments', label: 'Comments' }] : []),
]

// ============================================
// Pagination cursor from URL
// ============================================

const startAuthor = url.searchParams.get('start_author') || undefined
const startPermlink = url.searchParams.get('start_permlink') || undefined
const cursor: PaginationCursor | undefined = (startAuthor && startPermlink)
  ? { startAuthor, startPermlink }
  : undefined

// ============================================
// Fetch Hive data
// ============================================

try {
  const postsLimit = settings.postsPerPage || 20
  const postsSortOrder = (settings.postsSortOrder || 'blog') as IAccountPostsFilters['sort']
  const commentsSortOrder = (settings.commentsSortOrder || 'comments') as CommentSortOption

  if (hiveUsername) {
    // Initialize Blog Logic DataProvider (used for posts and manabars)
    const chain = await getWax()
    const dataProvider = new DataProvider(chain)

    // Fetch account, profile, global properties, and manabars (via Blog Logic)
    // Using Promise.allSettled for resilience - if one fails, others still succeed
    const [accountResult, profileResult, globalPropsResult, manabarResult] = await Promise.allSettled([
      getHiveAccount(hiveUsername),
      getHiveProfile(hiveUsername),
      getDynamicGlobalProperties(),
      // Use Blog Logic for manabars - fetch account first, then get manabars
      dataProvider.bloggingPlatform.getAccount(hiveUsername).then(account => account.getManabars()),
    ])

    // Extract successful results, log failures
    if (accountResult.status === 'fulfilled') {
      hiveAccount = accountResult.value
    } else {
      console.error('Failed to fetch Hive account:', accountResult.reason)
    }

    if (profileResult.status === 'fulfilled') {
      hiveProfile = profileResult.value
    } else {
      console.error('Failed to fetch Hive profile:', profileResult.reason)
    }

    if (globalPropsResult.status === 'fulfilled') {
      globalProperties = globalPropsResult.value
    } else {
      console.error('Failed to fetch global properties:', globalPropsResult.reason)
    }

    if (manabarResult.status === 'fulfilled') {
      accountManabars = manabarResult.value
    } else {
      console.error('Failed to fetch account manabars:', manabarResult.reason)
    }

    // Fetch content based on active tab with pagination
    if (activeTab === 'comments' && showCommentsTab) {
      const result = await getHiveCommentsPaginated(hiveUsername, commentsSortOrder, postsLimit, cursor)
      hiveComments = result.items
      hasMoreComments = result.hasMore
      nextCommentsCursor = result.nextCursor
    } else {
      // Use Blog Logic to fetch posts
      const posts = await dataProvider.bloggingPlatform.enumAccountPosts(
        { sort: postsSortOrder, account: hiveUsername },
        { page: 1, pageSize: postsLimit }
      )
      blogLogicPosts = [...posts] as Post[]

      // TODO: Blog Logic pagination - currently fetches first page only
      // Need to implement cursor-based pagination in Blog Logic
      hasMorePosts = blogLogicPosts.length >= postsLimit
      if (blogLogicPosts.length > 0) {
        const lastPost = blogLogicPosts[blogLogicPosts.length - 1]
        nextPostsCursor = { startAuthor: lastPost.author, startPermlink: lastPost.permlink }
      }
    }
  }
} catch (e) {
  console.error('Error fetching Hive data:', e)
  error = 'Error fetching data from Hive blockchain.'
}

// ============================================
// Settings with defaults
// ============================================

const siteName = settings.siteName || 'Hive Blog'
const siteDescription = settings.siteDescription || 'Posts from Hive blockchain'

// Use new pageLayout format, fallback to default
const pageLayout: PageLayout = settings.pageLayout?.sections?.length
  ? settings.pageLayout
  : defaultPageLayout

// Group sections by slot position
const sectionsBySlot: Record<PageSlotPosition, typeof pageLayout.sections> = {
  top: [],
  'sidebar-left': [],
  main: [],
  'sidebar-right': [],
  bottom: [],
}
pageLayout.sections.forEach(section => {
  if (sectionsBySlot[section.slot]) {
    sectionsBySlot[section.slot].push(section)
  }
})

// Helper: Get all elements in a slot (with null safety)
function getElementsInSlot(slot: PageSlotPosition): string[] {
  const sections = sectionsBySlot[slot]
  if (!sections || !Array.isArray(sections)) return []
  return sections.flatMap(section => section.elements || [])
}

// Helper: Check if element exists in a slot
function hasElementInSlot(slot: PageSlotPosition, elementId: string): boolean {
  return getElementsInSlot(slot).includes(elementId)
}

const hasLeftSidebar = getElementsInSlot('sidebar-left').length > 0
const hasRightSidebar = getElementsInSlot('sidebar-right').length > 0
const hasSidebars = hasLeftSidebar || hasRightSidebar

const showHeader = settings.showHeader !== false
const showAuthorProfile = settings.showAuthorProfile !== false
const authorAvatarSizePx = settings.authorAvatarSizePx ?? 64
const showPostCount = settings.showPostCount !== false
const showAuthorRewards = settings.showAuthorRewards !== false
const sidebarWidthPx = settings.sidebarWidthPx || 280

// Author Profile extended settings
const authorProfileLayout = settings.authorProfileLayout || 'horizontal'
const showAuthorAbout = settings.showAuthorAbout !== false
const showAuthorLocation = settings.showAuthorLocation !== false
const showAuthorWebsite = settings.showAuthorWebsite !== false
const showAuthorJoinDate = settings.showAuthorJoinDate !== false
const showAuthorReputation = settings.showAuthorReputation !== false
const showAuthorFollowers = settings.showAuthorFollowers !== false
const showAuthorFollowing = settings.showAuthorFollowing !== false
const showAuthorVotingPower = settings.showAuthorVotingPower ?? false
const showAuthorHiveBalance = settings.showAuthorHiveBalance ?? false
const showAuthorHbdBalance = settings.showAuthorHbdBalance ?? false
const showAuthorCoverImage = settings.showAuthorCoverImage !== false

// Shared props for AuthorProfile to reduce duplication
const authorProfileBaseProps = {
  username: hiveUsername,
  account: hiveAccount,
  profile: hiveProfile,
  globalProperties: globalProperties,
  accountManabars: accountManabars,
  avatarSize: authorAvatarSizePx,
  showPostCount: showPostCount,
  showRewards: showAuthorRewards,
  showAbout: showAuthorAbout,
  showLocation: showAuthorLocation,
  showWebsite: showAuthorWebsite,
  showJoinDate: showAuthorJoinDate,
  showReputation: showAuthorReputation,
  showFollowers: showAuthorFollowers,
  showFollowing: showAuthorFollowing,
  showVotingPower: showAuthorVotingPower,
  showHiveBalance: showAuthorHiveBalance,
  showHbdBalance: showAuthorHbdBalance,
  showCoverImage: showAuthorCoverImage,
}

// ============================================
// Pagination URL helpers
// ============================================

function buildNextPageUrl(tab: string, nextCursor: PaginationCursor | undefined): string | null {
  if (!nextCursor?.startAuthor || !nextCursor?.startPermlink) return null

  const nextUrl = new URL(url)
  nextUrl.searchParams.set('tab', tab)
  nextUrl.searchParams.set('start_author', nextCursor.startAuthor)
  nextUrl.searchParams.set('start_permlink', nextCursor.startPermlink)
  return nextUrl.pathname + nextUrl.search
}

const nextPostsPageUrl = buildNextPageUrl('posts', nextPostsCursor)
const nextCommentsPageUrl = buildNextPageUrl('comments', nextCommentsCursor)
const isFirstPage = !cursor
---

<Layout title={siteName} settings={settings}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    {/* Top sections - render elements in order */}
    {getElementsInSlot('top').map(elementId => (
      <div class="mb-6">
        {elementId === 'header' && showHeader && (
          <Header siteName={siteName} siteDescription={siteDescription} />
        )}
        {elementId === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
          <AuthorProfile {...authorProfileBaseProps} layout={authorProfileLayout} />
        )}
        {elementId === 'posts' && hiveUsername && (
          <>
            {tabs.length > 1 && activeTab === 'posts' && <ContentTabs tabs={tabs} activeTab={activeTab} />}
            {blogLogicPosts.length > 0 ? (
              <BlogLogicPostsGrid posts={blogLogicPosts} settings={settings} />
            ) : (
              <div class="text-center py-8 bg-bg-card rounded-xl border border-border">
                <p class="text-text-muted">No posts found</p>
              </div>
            )}
          </>
        )}
        {elementId === 'comments' && hiveUsername && showCommentsTab && (
          <>
            {tabs.length > 1 && activeTab === 'comments' && <ContentTabs tabs={tabs} activeTab={activeTab} />}
            {hiveComments.length > 0 ? (
              <div class="space-y-4">
                {hiveComments.map(comment => (
                  <CommentCard comment={comment} settings={settings} layout="list" />
                ))}
              </div>
            ) : (
              <div class="text-center py-8 bg-bg-card rounded-xl border border-border">
                <p class="text-text-muted">No comments found</p>
              </div>
            )}
          </>
        )}
        {elementId === 'navigation' && (
          <nav class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Navigation (placeholder)</p>
          </nav>
        )}
        {elementId === 'search' && (
          <div class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Search (placeholder)</p>
          </div>
        )}
        {elementId === 'tags' && (
          <div class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Tags Cloud (placeholder)</p>
          </div>
        )}
        {elementId === 'recentPosts' && (
          <div class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Recent Posts (placeholder)</p>
          </div>
        )}
        {elementId === 'footer' && (
          <Footer />
        )}
      </div>
    ))}

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {!hiveUsername && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text mb-2">Hive username is not configured.</p>
        <p class="text-text-muted">Set the HIVE_USERNAME environment variable in .env file</p>
      </div>
    )}

    {/* Main content with optional sidebars */}
    {hasSidebars ? (
      <div class="flex gap-8">
        {/* Left Sidebar */}
        {hasLeftSidebar && (
          <aside style={`width: ${sidebarWidthPx}px; flex-shrink: 0;`}>
            {getElementsInSlot('sidebar-left').map(elementId => (
              <div class="mb-4">
                {elementId === 'header' && showHeader && (
                  <div class="pb-4 border-b border-border">
                    <h1 class="text-xl font-bold text-text">{siteName}</h1>
                    <p class="text-text-muted mt-1 text-sm">{siteDescription}</p>
                  </div>
                )}
                {elementId === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
                  <AuthorProfile {...authorProfileBaseProps} layout="vertical" />
                )}
                {elementId === 'navigation' && (
                  <nav class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Navigation</p>
                  </nav>
                )}
                {elementId === 'search' && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Search</p>
                  </div>
                )}
                {elementId === 'tags' && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Tags</p>
                  </div>
                )}
                {elementId === 'recentPosts' && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Recent Posts</p>
                  </div>
                )}
                {elementId === 'posts' && hiveUsername && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    {blogLogicPosts.length > 0 ? (
                      <BlogLogicPostsGrid posts={blogLogicPosts} settings={settings} />
                    ) : (
                      <p class="text-text-muted text-xs">No posts</p>
                    )}
                  </div>
                )}
                {elementId === 'comments' && hiveUsername && showCommentsTab && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    {hiveComments.length > 0 ? (
                      <div class="space-y-2">
                        {hiveComments.slice(0, 5).map(comment => (
                          <CommentCard comment={comment} settings={settings} layout="list" />
                        ))}
                      </div>
                    ) : (
                      <p class="text-text-muted text-xs">No comments</p>
                    )}
                  </div>
                )}
                {elementId === 'footer' && (
                  <Footer />
                )}
              </div>
            ))}
          </aside>
        )}

        {/* Main Content */}
        <main class="flex-1 min-w-0">
          {getElementsInSlot('main').map(elementId => (
            <div class="mb-6">
              {elementId === 'header' && showHeader && (
                <Header siteName={siteName} siteDescription={siteDescription} />
              )}
              {elementId === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
                <AuthorProfile {...authorProfileBaseProps} layout={authorProfileLayout} />
              )}
              {elementId === 'posts' && hiveUsername && (
                <>
                  {tabs.length > 1 && <ContentTabs tabs={tabs} activeTab={activeTab} />}
                  {activeTab === 'posts' ? (
                    <>
                      {blogLogicPosts.length > 0 ? (
                        <>
                          <BlogLogicPostsGrid posts={blogLogicPosts} settings={settings} />
                          <div class="flex justify-between items-center mt-6 pt-4 border-t border-border">
                            {!isFirstPage ? (
                              <a href="/?tab=posts" class="px-4 py-2 bg-bg-card border border-border rounded-lg text-text hover:bg-primary hover:text-primary-text hover:border-primary transition-colors">
                                First page
                              </a>
                            ) : <span />}
                            {hasMorePosts && nextPostsPageUrl ? (
                              <a href={nextPostsPageUrl} class="px-4 py-2 bg-primary text-primary-text rounded-lg hover:bg-primary/90 transition-colors">
                                Load more posts
                              </a>
                            ) : <span />}
                          </div>
                        </>
                      ) : (
                        <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                          <p class="text-text">No posts found for @{hiveUsername}</p>
                        </div>
                      )}
                    </>
                  ) : (
                    <>
                      {hiveComments.length > 0 ? (
                        <>
                          {settings.commentsLayout === 'list' ? (
                            <div class="divide-y divide-border bg-bg-card rounded-xl shadow-sm border border-border overflow-hidden">
                              {hiveComments.map(comment => (
                                <CommentCard comment={comment} settings={settings} layout="list" />
                              ))}
                            </div>
                          ) : settings.commentsLayout === 'masonry' ? (
                            <div style={`column-count: ${settings.commentsGridColumns || 2}; column-gap: ${settings.commentsGapPx || 16}px;`}>
                              {hiveComments.map(comment => (
                                <div class="break-inside-avoid" style={`margin-bottom: ${settings.commentsGapPx || 16}px;`}>
                                  <CommentCard comment={comment} settings={settings} layout="masonry" />
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div style={`display: grid; grid-template-columns: repeat(${settings.commentsGridColumns || 2}, 1fr); gap: ${settings.commentsGapPx || 16}px;`}>
                              {hiveComments.map(comment => (
                                <CommentCard comment={comment} settings={settings} layout="grid" />
                              ))}
                            </div>
                          )}
                          <div class="flex justify-between items-center mt-6 pt-4 border-t border-border">
                            {!isFirstPage ? (
                              <a href="/?tab=comments" class="px-4 py-2 bg-bg-card border border-border rounded-lg text-text hover:bg-primary hover:text-primary-text hover:border-primary transition-colors">
                                First page
                              </a>
                            ) : <span />}
                            {hasMoreComments && nextCommentsPageUrl ? (
                              <a href={nextCommentsPageUrl} class="px-4 py-2 bg-primary text-primary-text rounded-lg hover:bg-primary/90 transition-colors">
                                Load more comments
                              </a>
                            ) : <span />}
                          </div>
                        </>
                      ) : (
                        <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                          <p class="text-text">No comments found for @{hiveUsername}</p>
                        </div>
                      )}
                    </>
                  )}
                </>
              )}
              {elementId === 'comments' && hiveUsername && showCommentsTab && (
                <>
                  {hiveComments.length > 0 ? (
                    <div class="space-y-4">
                      {hiveComments.map(comment => (
                        <CommentCard comment={comment} settings={settings} layout="list" />
                      ))}
                    </div>
                  ) : (
                    <div class="text-center py-8 bg-bg-card rounded-xl border border-border">
                      <p class="text-text-muted">No comments found</p>
                    </div>
                  )}
                </>
              )}
              {elementId === 'navigation' && (
                <nav class="bg-bg-card rounded-xl p-4 border border-border">
                  <p class="text-text-muted text-sm">Navigation (placeholder)</p>
                </nav>
              )}
              {elementId === 'search' && (
                <div class="bg-bg-card rounded-xl p-4 border border-border">
                  <p class="text-text-muted text-sm">Search (placeholder)</p>
                </div>
              )}
              {elementId === 'tags' && (
                <div class="bg-bg-card rounded-xl p-4 border border-border">
                  <p class="text-text-muted text-sm">Tags Cloud (placeholder)</p>
                </div>
              )}
              {elementId === 'recentPosts' && (
                <div class="bg-bg-card rounded-xl p-4 border border-border">
                  <p class="text-text-muted text-sm">Recent Posts (placeholder)</p>
                </div>
              )}
              {elementId === 'footer' && (
                <Footer />
              )}
            </div>
          ))}
        </main>

        {/* Right Sidebar */}
        {hasRightSidebar && (
          <aside style={`width: ${sidebarWidthPx}px; flex-shrink: 0;`}>
            {getElementsInSlot('sidebar-right').map(elementId => (
              <div class="mb-4">
                {elementId === 'header' && showHeader && (
                  <div class="pb-4 border-b border-border">
                    <h1 class="text-xl font-bold text-text">{siteName}</h1>
                    <p class="text-text-muted mt-1 text-sm">{siteDescription}</p>
                  </div>
                )}
                {elementId === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
                  <AuthorProfile {...authorProfileBaseProps} layout="vertical" />
                )}
                {elementId === 'navigation' && (
                  <nav class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Navigation</p>
                  </nav>
                )}
                {elementId === 'search' && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Search</p>
                  </div>
                )}
                {elementId === 'tags' && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Tags</p>
                  </div>
                )}
                {elementId === 'recentPosts' && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    <p class="text-text-muted text-xs">Recent Posts</p>
                  </div>
                )}
                {elementId === 'posts' && hiveUsername && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    {blogLogicPosts.length > 0 ? (
                      <BlogLogicPostsGrid posts={blogLogicPosts} settings={settings} />
                    ) : (
                      <p class="text-text-muted text-xs">No posts</p>
                    )}
                  </div>
                )}
                {elementId === 'comments' && hiveUsername && showCommentsTab && (
                  <div class="bg-bg-card rounded-lg p-3 border border-border">
                    {hiveComments.length > 0 ? (
                      <div class="space-y-2">
                        {hiveComments.slice(0, 5).map(comment => (
                          <CommentCard comment={comment} settings={settings} layout="list" />
                        ))}
                      </div>
                    ) : (
                      <p class="text-text-muted text-xs">No comments</p>
                    )}
                  </div>
                )}
                {elementId === 'footer' && (
                  <Footer />
                )}
              </div>
            ))}
          </aside>
        )}
      </div>
    ) : (
      /* No sidebars - render main content directly */
      <>
        {getElementsInSlot('main').map(elementId => (
          <div class="mb-6">
            {elementId === 'header' && showHeader && (
              <Header siteName={siteName} siteDescription={siteDescription} />
            )}
            {elementId === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
              <AuthorProfile {...authorProfileBaseProps} layout={authorProfileLayout} />
            )}
            {elementId === 'posts' && hiveUsername && (
              <>
                {tabs.length > 1 && <ContentTabs tabs={tabs} activeTab={activeTab} />}
                {activeTab === 'posts' ? (
                  <>
                    {blogLogicPosts.length > 0 ? (
                      <>
                        <BlogLogicPostsGrid posts={blogLogicPosts} settings={settings} />
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-border">
                          {!isFirstPage ? (
                            <a href="/?tab=posts" class="px-4 py-2 bg-bg-card border border-border rounded-lg text-text hover:bg-primary hover:text-primary-text hover:border-primary transition-colors">
                              First page
                            </a>
                          ) : <span />}
                          {hasMorePosts && nextPostsPageUrl ? (
                            <a href={nextPostsPageUrl} class="px-4 py-2 bg-primary text-primary-text rounded-lg hover:bg-primary/90 transition-colors">
                              Load more posts
                            </a>
                          ) : <span />}
                        </div>
                      </>
                    ) : (
                      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                        <p class="text-text">No posts found for @{hiveUsername}</p>
                      </div>
                    )}
                  </>
                ) : (
                  <>
                    {hiveComments.length > 0 ? (
                      <>
                        {settings.commentsLayout === 'list' ? (
                          <div class="divide-y divide-border bg-bg-card rounded-xl shadow-sm border border-border overflow-hidden">
                            {hiveComments.map(comment => (
                              <CommentCard comment={comment} settings={settings} layout="list" />
                            ))}
                          </div>
                        ) : settings.commentsLayout === 'masonry' ? (
                          <div style={`column-count: ${settings.commentsGridColumns || 2}; column-gap: ${settings.commentsGapPx || 16}px;`}>
                            {hiveComments.map(comment => (
                              <div class="break-inside-avoid" style={`margin-bottom: ${settings.commentsGapPx || 16}px;`}>
                                <CommentCard comment={comment} settings={settings} layout="masonry" />
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div style={`display: grid; grid-template-columns: repeat(${settings.commentsGridColumns || 2}, 1fr); gap: ${settings.commentsGapPx || 16}px;`}>
                            {hiveComments.map(comment => (
                              <CommentCard comment={comment} settings={settings} layout="grid" />
                            ))}
                          </div>
                        )}
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-border">
                          {!isFirstPage ? (
                            <a href="/?tab=comments" class="px-4 py-2 bg-bg-card border border-border rounded-lg text-text hover:bg-primary hover:text-primary-text hover:border-primary transition-colors">
                              First page
                            </a>
                          ) : <span />}
                          {hasMoreComments && nextCommentsPageUrl ? (
                            <a href={nextCommentsPageUrl} class="px-4 py-2 bg-primary text-primary-text rounded-lg hover:bg-primary/90 transition-colors">
                              Load more comments
                            </a>
                          ) : <span />}
                        </div>
                      </>
                    ) : (
                      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                        <p class="text-text">No comments found for @{hiveUsername}</p>
                      </div>
                    )}
                  </>
                )}
              </>
            )}
            {elementId === 'comments' && hiveUsername && showCommentsTab && (
              <>
                {hiveComments.length > 0 ? (
                  <div class="space-y-4">
                    {hiveComments.map(comment => (
                      <CommentCard comment={comment} settings={settings} layout="list" />
                    ))}
                  </div>
                ) : (
                  <div class="text-center py-8 bg-bg-card rounded-xl border border-border">
                    <p class="text-text-muted">No comments found</p>
                  </div>
                )}
              </>
            )}
            {elementId === 'navigation' && (
              <nav class="bg-bg-card rounded-xl p-4 border border-border">
                <p class="text-text-muted text-sm">Navigation (placeholder)</p>
              </nav>
            )}
            {elementId === 'search' && (
              <div class="bg-bg-card rounded-xl p-4 border border-border">
                <p class="text-text-muted text-sm">Search (placeholder)</p>
              </div>
            )}
            {elementId === 'tags' && (
              <div class="bg-bg-card rounded-xl p-4 border border-border">
                <p class="text-text-muted text-sm">Tags Cloud (placeholder)</p>
              </div>
            )}
            {elementId === 'recentPosts' && (
              <div class="bg-bg-card rounded-xl p-4 border border-border">
                <p class="text-text-muted text-sm">Recent Posts (placeholder)</p>
              </div>
            )}
            {elementId === 'footer' && (
              <Footer />
            )}
          </div>
        ))}
      </>
    )}

    {/* Bottom sections - render elements in order */}
    {getElementsInSlot('bottom').map(elementId => (
      <div class="mt-6">
        {elementId === 'header' && showHeader && (
          <div class="pt-4 border-t border-border">
            <h1 class="text-2xl font-bold text-text">{siteName}</h1>
            <p class="text-text-muted mt-1">{siteDescription}</p>
          </div>
        )}
        {elementId === 'authorProfile' && showAuthorProfile && hiveUsername && hiveAccount && (
          <AuthorProfile {...authorProfileBaseProps} layout={authorProfileLayout} />
        )}
        {elementId === 'posts' && hiveUsername && (
          <>
            {blogLogicPosts.length > 0 ? (
              <BlogLogicPostsGrid posts={blogLogicPosts} settings={settings} />
            ) : (
              <div class="text-center py-8 bg-bg-card rounded-xl border border-border">
                <p class="text-text-muted">No posts found</p>
              </div>
            )}
          </>
        )}
        {elementId === 'comments' && hiveUsername && showCommentsTab && (
          <>
            {hiveComments.length > 0 ? (
              <div class="space-y-4">
                {hiveComments.map(comment => (
                  <CommentCard comment={comment} settings={settings} layout="list" />
                ))}
              </div>
            ) : (
              <div class="text-center py-8 bg-bg-card rounded-xl border border-border">
                <p class="text-text-muted">No comments found</p>
              </div>
            )}
          </>
        )}
        {elementId === 'navigation' && (
          <nav class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Navigation (placeholder)</p>
          </nav>
        )}
        {elementId === 'search' && (
          <div class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Search (placeholder)</p>
          </div>
        )}
        {elementId === 'tags' && (
          <div class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Tags Cloud (placeholder)</p>
          </div>
        )}
        {elementId === 'recentPosts' && (
          <div class="bg-bg-card rounded-xl p-4 border border-border">
            <p class="text-text-muted text-sm">Recent Posts (placeholder)</p>
          </div>
        )}
        {elementId === 'footer' && (
          <Footer />
        )}
      </div>
    ))}
  </div>
</Layout>
