---
// SPDX-License-Identifier: AGPL-3.0-or-later
// Copyright (C) 2026 Krzysztof Kocot

import Layout from '../layouts/Layout.astro'
import { HIVE_USERNAME, IS_COMMUNITY } from '../lib/config'
import { prepare_community_page } from '../lib/ssr/prepare-community-page'
import { prepare_user_page } from '../lib/ssr/prepare-user-page'

import { BlogContent } from '../components/home/blog/BlogContent'
import { CommunityContent } from '../components/community/CommunityContent'

import SlotRenderer from '../components/home/blog/SlotRenderer.astro'
import NoscriptFallback from '../components/home/blog/NoscriptFallback.astro'
import { type SiteSettings, type PageLayout, type PageSlotPosition, defaultPageLayout, defaultCommunityPageLayout } from '../components/home/types'

import type { IPaginationCursor } from '@hiveio/workerbee/blog-logic'

// ============================================
// SSR Data Preparation (delegated to modules)
// ============================================

const hiveUsername = import.meta.env.HIVE_USERNAME || process.env.HIVE_USERNAME
const url = new URL(Astro.request.url)

const community_page = IS_COMMUNITY && hiveUsername
  ? await prepare_community_page(hiveUsername, {
      sort: url.searchParams.get('sort') || undefined,
      start_author: url.searchParams.get('start_author') || undefined,
      start_permlink: url.searchParams.get('start_permlink') || undefined,
    })
  : null

const user_page = !IS_COMMUNITY && hiveUsername
  ? await prepare_user_page(hiveUsername, {
      tab: url.searchParams.get('tab') || undefined,
      start_author: url.searchParams.get('start_author') || undefined,
      start_permlink: url.searchParams.get('start_permlink') || undefined,
    })
  : null

// Unified access to settings and state
const settings: SiteSettings = community_page?.settings ?? user_page?.settings ?? {}
const dehydrated_state = community_page?.dehydrated_state ?? user_page?.dehydrated_state ?? null
const error = community_page?.error ?? user_page?.error ?? null

// ============================================
// Settings with defaults
// ============================================

const communityTitle = community_page?.community_data?.title || HIVE_USERNAME
const defaultSiteName = IS_COMMUNITY
  ? (communityTitle || 'Hive Community')
  : (HIVE_USERNAME ? `${HIVE_USERNAME} Blog` : 'Hive Blog')
const siteName = settings.siteName || defaultSiteName
const defaultDescription = IS_COMMUNITY
  ? (community_page?.community_data?.about || 'Hive community')
  : 'Posts from Hive blockchain'
const siteDescription = settings.siteDescription || defaultDescription

// Use new pageLayout format, fallback to mode-appropriate default
const pageLayout: PageLayout = settings.pageLayout?.sections?.length
  ? settings.pageLayout
  : IS_COMMUNITY ? defaultCommunityPageLayout : defaultPageLayout

// Group sections by slot position
const sectionsBySlot: Record<PageSlotPosition, typeof pageLayout.sections> = {
  top: [],
  'sidebar-left': [],
  main: [],
  'sidebar-right': [],
  bottom: [],
}
pageLayout.sections.forEach(section => {
  if (sectionsBySlot[section.slot]) {
    sectionsBySlot[section.slot].push(section)
  }
})

// Helper: Get all elements in a slot (with null safety)
function getElementsInSlot(slot: PageSlotPosition): string[] {
  const sections = sectionsBySlot[slot]
  if (!sections || !Array.isArray(sections)) return []
  return sections.flatMap(section => section.elements || [])
}

// Helper: Check if element exists in a slot
function hasElementInSlot(slot: PageSlotPosition, elementId: string): boolean {
  return getElementsInSlot(slot).includes(elementId)
}

const hasLeftSidebar = getElementsInSlot('sidebar-left').length > 0
const hasRightSidebar = getElementsInSlot('sidebar-right').length > 0
const hasSidebars = hasLeftSidebar || hasRightSidebar

const showHeader = settings.showHeader !== false
const showAuthorProfile = settings.showAuthorProfile !== false
const authorAvatarSizePx = settings.authorAvatarSizePx ?? 64
const sidebarWidthPx = settings.sidebarWidthPx || 280

// Size settings for Author Profile
const authorCoverHeight = settings.authorCoverHeightPx ?? 64
const authorUsernameSize = settings.authorUsernameSizePx ?? 14
const authorDisplayNameSize = settings.authorDisplayNameSizePx ?? 18
const authorAboutSize = settings.authorAboutSizePx ?? 14
const authorStatsSize = settings.authorStatsSizePx ?? 14
const authorMetaSize = settings.authorMetaSizePx ?? 12

// ============================================
// Unpack mode-specific data
// ============================================

// Community mode
const communityData = community_page?.community_data ?? null
const communitySortOrder = community_page?.community_sort_order ?? 'trending'

// User mode
const hiveAccount = user_page?.hive_account ?? null
const hiveProfile = user_page?.hive_profile ?? null
const globalProperties = user_page?.global_properties ?? null
const accountManabars = user_page?.account_manabars ?? null
const blogLogicPosts = user_page?.blog_logic_posts ?? []
const hiveComments = user_page?.hive_comments ?? []
const activeTab = user_page?.active_tab ?? 'posts'
const showCommentsTab = user_page?.show_comments_tab ?? false
const activeCategoryTag = user_page?.active_category_tag ?? null
const postsSortOrder = user_page?.posts_sort_order ?? 'blog'
const commentsSortOrder = user_page?.comments_sort_order ?? 'comments'
const postsLimit = community_page?.posts_limit ?? user_page?.posts_limit ?? 20
const hasMorePosts = community_page?.has_more_posts ?? user_page?.has_more_posts ?? false
const hasMoreComments = user_page?.has_more_comments ?? false
const nextPostsCursor = user_page?.next_posts_cursor
const nextCommentsCursor = user_page?.next_comments_cursor
const totalFetchedBeforeFilter = user_page?.total_fetched_before_filter ?? 0

// Shared props for AuthorProfile to reduce duplication
const authorProfileBaseProps = {
  username: hiveUsername,
  account: hiveAccount,
  profile: hiveProfile,
  globalProperties: globalProperties,
  accountManabars: accountManabars,
  profileLayout: settings.authorProfileLayout2,
  avatarSize: authorAvatarSizePx,
  coverHeight: authorCoverHeight,
  usernameSize: authorUsernameSize,
  displayNameSize: authorDisplayNameSize,
  aboutSize: authorAboutSize,
  statsSize: authorStatsSize,
  metaSize: authorMetaSize,
  socialLinks: settings.socialLinks || [],
}

// ============================================
// Pagination URL helpers
// ============================================

function buildNextPageUrl(tab: string, nextCursor: IPaginationCursor | undefined): string | null {
  if (!nextCursor?.startAuthor || !nextCursor?.startPermlink) return null

  const nextUrl = new URL(url)
  nextUrl.searchParams.set('tab', tab)
  nextUrl.searchParams.set('start_author', nextCursor.startAuthor)
  nextUrl.searchParams.set('start_permlink', nextCursor.startPermlink)
  return nextUrl.pathname + nextUrl.search
}

const nextPostsPageUrl = buildNextPageUrl('posts', nextPostsCursor)
const nextCommentsPageUrl = buildNextPageUrl('comments', nextCommentsCursor)
const cursor = (url.searchParams.get('start_author') && url.searchParams.get('start_permlink')) ? true : false
const isFirstPage = !cursor

const isCategory = !!activeCategoryTag
const showCategoryLimitWarning = isCategory && totalFetchedBeforeFilter >= (settings.postsPerPage || 20)

// Common props for SlotRenderer
const slotRendererProps = {
  siteName,
  siteDescription,
  showHeader,
  hiveUsername,
  hiveAccount,
  hiveProfile,
  globalProperties,
  accountManabars,
  blogLogicPosts,
  hiveComments,
  activeTab,
  showCommentsTab,
  settings,
  showAuthorProfile,
  authorProfileBaseProps,
  isCategory,
  activeCategoryTag,
  totalFetchedBeforeFilter,
  showCategoryLimitWarning,
  isFirstPage,
  hasMorePosts,
  nextPostsPageUrl,
  hasMoreComments,
  nextCommentsPageUrl,
  communityData,
}
---

<Layout title={siteName} settings={settings}>
  <div class="max-w-7xl mx-auto px-4 py-16">

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Error:</strong> {error}
      </div>
    )}

    {!hiveUsername && !error && (
      <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
        <p class="text-text mb-2">Hive username is not configured.</p>
        <p class="text-text-muted">Set the HIVE_USERNAME environment variable in .env file</p>
      </div>
    )}

    {/* ============================================ */}
    {/* COMMUNITY MODE */}
    {/* ============================================ */}
    {IS_COMMUNITY && hiveUsername && (
      <>
        {/* Top sections - render elements in order */}
        <SlotRenderer sections={sectionsBySlot['top']} context="top" {...slotRendererProps} />

        {/* Main content with optional sidebars - Responsive Layout */}
        {hasSidebars ? (
          <div class="sidebar-layout">
            {/* Left Sidebar */}
            {hasLeftSidebar && (
              <aside class="sidebar-left" style={`--sidebar-width: ${sidebarWidthPx}px;`}>
                <SlotRenderer sections={sectionsBySlot['sidebar-left']} context="sidebar-left" {...slotRendererProps} />
              </aside>
            )}

            {/* Main Content */}
            <main class="main-content">
              {dehydrated_state && (
                <div class="js-only">
                  <CommunityContent
                    client:only="solid-js"
                    community_name={hiveUsername}
                    initial_sort={communitySortOrder}
                    posts_per_page={postsLimit}
                    settings={settings}
                    dehydrated_state={dehydrated_state}
                    post_card_layout={settings.postCardLayout}
                  />
                </div>
              )}
              {!dehydrated_state && (
                <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                  <p class="text-text-muted">Loading community...</p>
                </div>
              )}
            </main>

            {/* Right Sidebar */}
            {hasRightSidebar && (
              <aside class="sidebar-right" style={`--sidebar-width: ${sidebarWidthPx}px;`}>
                <SlotRenderer sections={sectionsBySlot['sidebar-right']} context="sidebar-right" {...slotRendererProps} />
              </aside>
            )}
          </div>
        ) : (
          /* No sidebars - render main content directly */
          <>
            {dehydrated_state && (
              <div class="js-only">
                <CommunityContent
                  client:only="solid-js"
                  community_name={hiveUsername}
                  initial_sort={communitySortOrder}
                  posts_per_page={postsLimit}
                  settings={settings}
                  dehydrated_state={dehydrated_state}
                  post_card_layout={settings.postCardLayout}
                />
              </div>
            )}
            {!dehydrated_state && (
              <div class="text-center py-12 bg-bg-card rounded-xl shadow-sm border border-border">
                <p class="text-text-muted">Loading community...</p>
              </div>
            )}
          </>
        )}

        {/* Bottom sections */}
        <SlotRenderer sections={sectionsBySlot['bottom']} context="bottom" {...slotRendererProps} />
      </>
    )}

    {/* ============================================ */}
    {/* USER MODE (unchanged) */}
    {/* ============================================ */}
    {!IS_COMMUNITY && (
      <>
        {/* Top sections - render elements in order */}
        <SlotRenderer sections={sectionsBySlot['top']} context="top" {...slotRendererProps} />

        {/* Main content with optional sidebars - Responsive Layout */}
        {hasSidebars ? (
          <div class="sidebar-layout">
            {/* Left Sidebar */}
            {hasLeftSidebar && (
              <aside class="sidebar-left" style={`--sidebar-width: ${sidebarWidthPx}px;`}>
                <SlotRenderer sections={sectionsBySlot['sidebar-left']} context="sidebar-left" {...slotRendererProps} />
              </aside>
            )}

            {/* Main Content */}
            <main class="main-content">
              {hiveUsername && dehydrated_state && hasElementInSlot('main', 'navigation') && (
                <SlotRenderer
                  sections={sectionsBySlot['main']
                    .filter(section => section.elements.includes('navigation'))
                    .map(section => ({
                      ...section,
                      elements: section.elements.filter(el => el === 'navigation')
                    }))}
                  context="main"
                  {...slotRendererProps}
                />
              )}

              {hiveUsername && dehydrated_state && (
                <>
                  <noscript>
                    <NoscriptFallback active_tab={activeTab} blog_logic_posts={blogLogicPosts} hive_comments={hiveComments} />
                  </noscript>
                  <div class="js-only">
                    <BlogContent
                      client:only="solid-js"
                      hive_username={hiveUsername}
                      initial_tab={activeTab}
                      show_comments_tab={showCommentsTab}
                      posts_sort_order={postsSortOrder}
                      comments_sort_order={commentsSortOrder}
                      posts_per_page={postsLimit}
                      settings={settings}
                      dehydrated_state={dehydrated_state}
                      category_tag={activeCategoryTag}
                      navigation_tabs={settings.navigationTabs}
                      post_card_layout={settings.postCardLayout}
                    />
                  </div>
                </>
              )}
              {(!hiveUsername || !dehydrated_state) && (
                <SlotRenderer sections={sectionsBySlot['main']} context="main" {...slotRendererProps} />
              )}
            </main>

            {/* Right Sidebar */}
            {hasRightSidebar && (
              <aside class="sidebar-right" style={`--sidebar-width: ${sidebarWidthPx}px;`}>
                <SlotRenderer sections={sectionsBySlot['sidebar-right']} context="sidebar-right" {...slotRendererProps} />
              </aside>
            )}
          </div>
        ) : (
          /* No sidebars - render main content directly */
          <>
            {hiveUsername && dehydrated_state && hasElementInSlot('main', 'navigation') && (
              <SlotRenderer
                sections={sectionsBySlot['main']
                  .filter(section => section.elements.includes('navigation'))
                  .map(section => ({
                    ...section,
                    elements: section.elements.filter(el => el === 'navigation')
                  }))}
                context="main"
                {...slotRendererProps}
              />
            )}

            {hiveUsername && dehydrated_state && (
              <>
                <noscript>
                  <NoscriptFallback active_tab={activeTab} blog_logic_posts={blogLogicPosts} hive_comments={hiveComments} />
                </noscript>
                <div class="js-only">
                  <BlogContent
                    client:only="solid-js"
                    hive_username={hiveUsername}
                    initial_tab={activeTab}
                    show_comments_tab={showCommentsTab}
                    posts_sort_order={postsSortOrder}
                    comments_sort_order={commentsSortOrder}
                    posts_per_page={postsLimit}
                    settings={settings}
                    dehydrated_state={dehydrated_state}
                    category_tag={activeCategoryTag}
                    navigation_tabs={settings.navigationTabs}
                    post_card_layout={settings.postCardLayout}
                  />
                </div>
              </>
            )}
            {(!hiveUsername || !dehydrated_state) && (
              <SlotRenderer sections={sectionsBySlot['main']} context="main" {...slotRendererProps} />
            )}
          </>
        )}

        {/* Bottom sections */}
        <SlotRenderer sections={sectionsBySlot['bottom']} context="bottom" {...slotRendererProps} />
      </>
    )}
  </div>
</Layout>
