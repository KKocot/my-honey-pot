---
import Layout from '../layouts/Layout.astro'
import { getPayloadClient } from '../lib/payload'

interface Post {
  id: string
  title: string
  slug: string
  excerpt?: string
  publishedDate?: string
  status: 'draft' | 'published'
}

let posts: Post[] = []
let error: string | null = null

try {
  const payload = await getPayloadClient()
  const result = await payload.find({
    collection: 'posts',
    where: {
      status: { equals: 'published' },
    },
    sort: '-publishedDate',
  })
  posts = result.docs as Post[]
} catch (e) {
  console.error('Error fetching posts:', e)
  error = 'Błąd połączenia z bazą danych.'
}
---

<Layout title="Astro + Payload CMS">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <header class="flex justify-between items-center mb-8 pb-4 border-b-2 border-gray-200">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Astro + Payload CMS</h1>
        <p class="text-gray-500 mt-1">Projekt startowy z integracją Payload CMS</p>
      </div>
      <a
        href="/admin"
        class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm font-medium"
      >
        Admin
      </a>
    </header>

    <main>
      {error && (
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
          <strong>Błąd:</strong> {error}
        </div>
      )}

      {posts.length > 0 ? (
        <div class="space-y-6">
          {posts.map((post) => (
            <article class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
              <h2 class="text-xl font-semibold mb-2">
                <a
                  href={`/posts/${post.slug}`}
                  class="text-gray-800 hover:text-blue-600 transition-colors"
                >
                  {post.title}
                </a>
              </h2>
              {post.publishedDate && (
                <p class="text-gray-400 text-sm mb-2">
                  {new Date(post.publishedDate).toLocaleDateString('pl-PL')}
                </p>
              )}
              {post.excerpt && (
                <p class="text-gray-600">{post.excerpt}</p>
              )}
            </article>
          ))}
        </div>
      ) : !error && (
        <div class="text-center py-12 bg-white rounded-xl shadow-sm">
          <p class="text-gray-600 mb-2">Brak opublikowanych postów.</p>
          <p class="text-gray-500 mb-4">Dodaj pierwszy post w panelu administracyjnym.</p>
          <a
            href="/admin"
            class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
          >
            Otwórz Panel Admin
          </a>
        </div>
      )}
    </main>
  </div>
</Layout>
