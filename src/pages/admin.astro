---
// Admin panel - server-side rendered
---

<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Admin Panel - Astro + Payload</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; padding: 2rem; background: #1a1a2e; color: #eee; }
    h1 { margin-bottom: 2rem; }
    .container { max-width: 1000px; margin: 0 auto; }
    .back-link { color: #e94560; text-decoration: none; display: inline-block; margin-bottom: 1rem; }
    .back-link:hover { text-decoration: underline; }
    .card { background: #16213e; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; }
    .card h2 { color: #e94560; margin-bottom: 1rem; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    label { font-weight: bold; }
    input, textarea, select { padding: 0.5rem; border: 1px solid #333; border-radius: 4px; background: #0f0f23; color: #fff; width: 100%; }
    textarea { min-height: 150px; resize: vertical; }
    button { padding: 0.75rem 1.5rem; background: #e94560; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
    button:hover { background: #d63850; }
    .posts-list { margin-top: 2rem; }
    .post-item { background: #0f3460; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .post-info { flex: 1; }
    .post-title { font-weight: bold; display: block; }
    .post-slug { font-size: 0.8rem; color: #888; }
    .post-status { font-size: 0.8rem; padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
    .post-status.published { background: #4caf50; }
    .post-status.draft { background: #ff9800; }
    .btn-delete { background: #f44336; padding: 0.5rem 1rem; font-size: 0.875rem; }
    .message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
    .message.success { background: #4caf50; display: block; }
    .message.error { background: #f44336; display: block; }
    .loading { color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; Powrót do strony</a>
    <h1>Admin Panel</h1>

    <div id="message" class="message"></div>

    <div class="card">
      <h2>Dodaj nowy post</h2>
      <form id="postForm">
        <div>
          <label for="title">Tytuł</label>
          <input type="text" id="title" name="title" required>
        </div>

        <div>
          <label for="slug">Slug (URL)</label>
          <input type="text" id="slug" name="slug" required placeholder="moj-pierwszy-post">
        </div>

        <div>
          <label for="content">Treść</label>
          <textarea id="content" name="content" required placeholder="Treść posta..."></textarea>
        </div>

        <div>
          <label for="excerpt">Zajawka</label>
          <textarea id="excerpt" name="excerpt" rows="2" placeholder="Krótki opis..."></textarea>
        </div>

        <div>
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="draft">Szkic</option>
            <option value="published">Opublikowany</option>
          </select>
        </div>

        <button type="submit">Dodaj post</button>
      </form>
    </div>

    <div class="card posts-list">
      <h2>Lista postów</h2>
      <div id="posts" class="loading">Ładowanie...</div>
    </div>
  </div>

  <script>
    const messageDiv = document.getElementById('message');
    const postsDiv = document.getElementById('posts');
    const form = document.getElementById('postForm');

    function showMessage(text, type) {
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      setTimeout(() => {
        messageDiv.className = 'message';
      }, 3000);
    }

    async function loadPosts() {
      try {
        const res = await fetch('/api/admin/posts');
        const data = await res.json();

        if (data.docs.length === 0) {
          postsDiv.innerHTML = '<p>Brak postów. Dodaj pierwszy post powyżej.</p>';
          return;
        }

        postsDiv.innerHTML = data.docs.map(post => `
          <div class="post-item">
            <div class="post-info">
              <span class="post-title">${post.title}</span>
              <span class="post-slug">/${post.slug}</span>
              <span class="post-status ${post.status}">${post.status === 'published' ? 'Opublikowany' : 'Szkic'}</span>
            </div>
            <button class="btn-delete" onclick="deletePost('${post.id}')">Usuń</button>
          </div>
        `).join('');
      } catch (e) {
        postsDiv.innerHTML = '<p>Błąd ładowania postów</p>';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        title: form.title.value,
        slug: form.slug.value,
        content: form.content.value,
        excerpt: form.excerpt.value,
        status: form.status.value,
        publishedDate: new Date().toISOString()
      };

      try {
        const res = await fetch('/api/admin/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          showMessage('Post dodany!', 'success');
          form.reset();
          loadPosts();
        } else {
          const error = await res.json();
          showMessage('Błąd: ' + (error.error || 'Nie udało się dodać posta'), 'error');
        }
      } catch (e) {
        showMessage('Błąd połączenia z serwerem', 'error');
      }
    });

    window.deletePost = async function(id) {
      if (!confirm('Czy na pewno chcesz usunąć ten post?')) return;

      try {
        const res = await fetch('/api/admin/posts/' + id, { method: 'DELETE' });
        if (res.ok) {
          showMessage('Post usunięty!', 'success');
          loadPosts();
        } else {
          showMessage('Błąd usuwania posta', 'error');
        }
      } catch (e) {
        showMessage('Błąd połączenia z serwerem', 'error');
      }
    };

    // Auto-generate slug from title
    document.getElementById('title').addEventListener('input', (e) => {
      const slugInput = document.getElementById('slug');
      if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        slugInput.value = e.target.value
          .toLowerCase()
          .replace(/[ąą]/g, 'a')
          .replace(/[ćć]/g, 'c')
          .replace(/[ęę]/g, 'e')
          .replace(/[łł]/g, 'l')
          .replace(/[ńń]/g, 'n')
          .replace(/[óó]/g, 'o')
          .replace(/[śś]/g, 's')
          .replace(/[źź]/g, 'z')
          .replace(/[żż]/g, 'z')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        slugInput.dataset.autoGenerated = 'true';
      }
    });

    document.getElementById('slug').addEventListener('input', (e) => {
      e.target.dataset.autoGenerated = 'false';
    });

    loadPosts();
  </script>
</body>
</html>
