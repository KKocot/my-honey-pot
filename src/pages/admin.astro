---
import Layout from '../layouts/Layout.astro'
---

<Layout title="Admin Panel - Astro + Payload">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <a
      href="/"
      class="inline-flex items-center text-primary hover:text-primary-hover mb-6 transition-colors"
    >
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Powrót do strony
    </a>

    <h1 class="text-3xl font-bold text-text mb-8">Admin Panel</h1>

    <div id="message" class="hidden mb-6 px-4 py-3 rounded-lg font-medium"></div>

    <!-- Site Settings Card -->
    <div class="bg-bg-card rounded-xl p-6 mb-6 border border-border">
      <h2 class="text-xl font-semibold text-primary mb-6">Ustawienia strony</h2>

      <form id="settingsForm" class="space-y-4">
        <div>
          <label for="siteTheme" class="block text-sm font-medium text-text mb-1">Motyw kolorystyczny</label>
          <select
            id="siteTheme"
            name="siteTheme"
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          >
            <option value="light">Jasny (Light)</option>
            <option value="dark">Ciemny (Dark)</option>
            <option value="green">Zielony (Green)</option>
            <option value="pink">Różowy (Pink)</option>
          </select>
        </div>

        <div>
          <label for="siteName" class="block text-sm font-medium text-text mb-1">Nazwa strony</label>
          <input
            type="text"
            id="siteName"
            name="siteName"
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          />
        </div>

        <div>
          <label for="siteDescription" class="block text-sm font-medium text-text mb-1">Opis strony</label>
          <textarea
            id="siteDescription"
            name="siteDescription"
            rows="2"
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-y"
          ></textarea>
        </div>

        <button
          type="submit"
          class="w-full sm:w-auto px-6 py-2.5 bg-accent text-bg-card font-medium rounded-lg hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-bg"
        >
          Zapisz ustawienia
        </button>
      </form>
    </div>

    <!-- Form Card -->
    <div class="bg-bg-card rounded-xl p-6 mb-6 border border-border">
      <h2 class="text-xl font-semibold text-primary mb-6">Dodaj nowy post</h2>

      <form id="postForm" class="space-y-4">
        <div>
          <label for="title" class="block text-sm font-medium text-text mb-1">Tytuł</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          />
        </div>

        <div>
          <label for="slug" class="block text-sm font-medium text-text mb-1">Slug (URL)</label>
          <input
            type="text"
            id="slug"
            name="slug"
            required
            placeholder="moj-pierwszy-post"
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          />
        </div>

        <div>
          <label for="content" class="block text-sm font-medium text-text mb-1">Treść</label>
          <textarea
            id="content"
            name="content"
            required
            placeholder="Treść posta..."
            rows="6"
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-y"
          ></textarea>
        </div>

        <div>
          <label for="excerpt" class="block text-sm font-medium text-text mb-1">Zajawka</label>
          <textarea
            id="excerpt"
            name="excerpt"
            rows="2"
            placeholder="Krótki opis..."
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-y"
          ></textarea>
        </div>

        <div>
          <label for="status" class="block text-sm font-medium text-text mb-1">Status</label>
          <select
            id="status"
            name="status"
            class="w-full px-4 py-2 bg-bg border border-border rounded-lg text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          >
            <option value="draft">Szkic</option>
            <option value="published">Opublikowany</option>
          </select>
        </div>

        <button
          type="submit"
          class="w-full sm:w-auto px-6 py-2.5 bg-primary text-bg-card font-medium rounded-lg hover:bg-primary-hover transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-bg"
        >
          Dodaj post
        </button>
      </form>
    </div>

    <!-- Posts List Card -->
    <div class="bg-bg-card rounded-xl p-6 border border-border">
      <h2 class="text-xl font-semibold text-primary mb-6">Lista postów</h2>
      <div id="posts" class="text-text-muted">Ładowanie...</div>
    </div>
  </div>

  <script>
    const messageDiv = document.getElementById('message') as HTMLDivElement
    const postsDiv = document.getElementById('posts') as HTMLDivElement
    const form = document.getElementById('postForm') as HTMLFormElement

    function showMessage(text: string, type: 'success' | 'error'): void {
      messageDiv.textContent = text
      messageDiv.className = type === 'success'
        ? 'mb-6 px-4 py-3 rounded-lg font-medium bg-success/20 text-success border border-success/30'
        : 'mb-6 px-4 py-3 rounded-lg font-medium bg-error/20 text-error border border-error/30'
      setTimeout(() => {
        messageDiv.className = 'hidden'
      }, 3000)
    }

    interface PostData {
      id: string
      title: string
      slug: string
      status: 'draft' | 'published'
    }

    interface PostsResponse {
      docs: PostData[]
    }

    async function loadPosts(): Promise<void> {
      try {
        const res = await fetch('/api/admin/posts')
        const data: PostsResponse = await res.json()

        if (data.docs.length === 0) {
          postsDiv.innerHTML = '<p class="text-text-muted">Brak postów. Dodaj pierwszy post powyżej.</p>'
          return
        }

        postsDiv.innerHTML = data.docs.map((post: PostData) => `
          <div class="flex flex-wrap items-center justify-between gap-3 p-4 bg-bg-secondary rounded-lg mb-3">
            <div class="flex-1 min-w-0">
              <span class="block font-medium text-text truncate">${post.title}</span>
              <span class="text-sm text-text-muted">/${post.slug}</span>
              <span class="inline-block ml-2 px-2 py-0.5 text-xs rounded ${
                post.status === 'published'
                  ? 'bg-success/20 text-success'
                  : 'bg-warning/20 text-warning'
              }">
                ${post.status === 'published' ? 'Opublikowany' : 'Szkic'}
              </span>
            </div>
            <button
              onclick="deletePost('${post.id}')"
              class="px-4 py-1.5 bg-error/20 text-error rounded-lg hover:bg-error/30 transition-colors text-sm font-medium"
            >
              Usuń
            </button>
          </div>
        `).join('')
      } catch {
        postsDiv.innerHTML = '<p class="text-error">Błąd ładowania postów</p>'
      }
    }

    form.addEventListener('submit', async (e: SubmitEvent) => {
      e.preventDefault()

      const formData = new FormData(form)
      const data = {
        title: formData.get('title'),
        slug: formData.get('slug'),
        content: formData.get('content'),
        excerpt: formData.get('excerpt'),
        status: formData.get('status'),
        publishedDate: new Date().toISOString()
      }

      try {
        const res = await fetch('/api/admin/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })

        if (res.ok) {
          showMessage('Post dodany!', 'success')
          form.reset()
          loadPosts()
        } else {
          const error = await res.json()
          showMessage('Błąd: ' + (error.error || 'Nie udało się dodać posta'), 'error')
        }
      } catch {
        showMessage('Błąd połączenia z serwerem', 'error')
      }
    })

    ;(window as Window & { deletePost: (id: string) => Promise<void> }).deletePost = async function(id: string): Promise<void> {
      if (!confirm('Czy na pewno chcesz usunąć ten post?')) return

      try {
        const res = await fetch('/api/admin/posts/' + id, { method: 'DELETE' })
        if (res.ok) {
          showMessage('Post usunięty!', 'success')
          loadPosts()
        } else {
          showMessage('Błąd usuwania posta', 'error')
        }
      } catch {
        showMessage('Błąd połączenia z serwerem', 'error')
      }
    }

    const titleInput = document.getElementById('title') as HTMLInputElement
    const slugInput = document.getElementById('slug') as HTMLInputElement

    titleInput.addEventListener('input', () => {
      if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        slugInput.value = titleInput.value
          .toLowerCase()
          .replace(/[ąą]/g, 'a')
          .replace(/[ćć]/g, 'c')
          .replace(/[ęę]/g, 'e')
          .replace(/[łł]/g, 'l')
          .replace(/[ńń]/g, 'n')
          .replace(/[óó]/g, 'o')
          .replace(/[śś]/g, 's')
          .replace(/[źź]/g, 'z')
          .replace(/[żż]/g, 'z')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '')
        slugInput.dataset.autoGenerated = 'true'
      }
    })

    slugInput.addEventListener('input', () => {
      slugInput.dataset.autoGenerated = 'false'
    })

    loadPosts()

    // Settings handling
    const settingsForm = document.getElementById('settingsForm') as HTMLFormElement
    const siteThemeSelect = document.getElementById('siteTheme') as HTMLSelectElement
    const siteNameInput = document.getElementById('siteName') as HTMLInputElement
    const siteDescriptionTextarea = document.getElementById('siteDescription') as HTMLTextAreaElement

    interface SettingsData {
      siteTheme: 'light' | 'dark' | 'green' | 'pink'
      siteName: string
      siteDescription: string
    }

    async function loadSettings(): Promise<void> {
      try {
        const res = await fetch('/api/admin/settings')
        const data: SettingsData = await res.json()

        siteThemeSelect.value = data.siteTheme || 'light'
        siteNameInput.value = data.siteName || ''
        siteDescriptionTextarea.value = data.siteDescription || ''

        document.documentElement.setAttribute('data-theme', data.siteTheme || 'light')
      } catch {
        console.error('Błąd ładowania ustawień')
      }
    }

    settingsForm.addEventListener('submit', async (e: SubmitEvent) => {
      e.preventDefault()

      const data: SettingsData = {
        siteTheme: siteThemeSelect.value as SettingsData['siteTheme'],
        siteName: siteNameInput.value,
        siteDescription: siteDescriptionTextarea.value,
      }

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        })

        if (res.ok) {
          showMessage('Ustawienia zapisane!', 'success')
          document.documentElement.setAttribute('data-theme', data.siteTheme)
        } else {
          showMessage('Błąd zapisu ustawień', 'error')
        }
      } catch {
        showMessage('Błąd połączenia z serwerem', 'error')
      }
    })

    loadSettings()
  </script>
</Layout>
