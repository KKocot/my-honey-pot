---
// SPDX-License-Identifier: AGPL-3.0-or-later
// Copyright (C) 2026 Krzysztof Kocot

import Layout from '../layouts/Layout.astro'
import { AdminPanel } from '../components/admin'
import { load_and_prepare_config } from '../lib/config-pipeline'
import type { SettingsData } from '../components/admin/types'
import { get_default_settings } from '../components/admin/types'
import { HIVE_USERNAME, IS_COMMUNITY } from '../lib/config'

// Load initial settings from Hive on server via unified pipeline
let initialSettings: SettingsData | null = null
const hiveUsername = HIVE_USERNAME

if (hiveUsername) {
  try {
    initialSettings = await load_and_prepare_config(hiveUsername, IS_COMMUNITY)
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Unknown error'
    console.error('Admin: Failed to load config from Hive:', message)
    initialSettings = { ...get_default_settings(IS_COMMUNITY), hiveUsername: hiveUsername }
  }
}
---

<Layout title={`Admin Panel - ${hiveUsername ? `${hiveUsername} Blog` : 'Hive Blog'}`}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <a
      href="/"
      class="inline-flex items-center text-primary hover:text-primary-hover mb-6 transition-colors"
    >
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to site
    </a>

    <h1 class="text-3xl font-bold text-text mb-8">Admin Panel</h1>

    <AdminPanel
      client:only="solid-js"
      initialSettings={initialSettings}
      ownerUsername={hiveUsername}
    />
  </div>
</Layout>
