---
import Layout from '../../layouts/Layout.astro'
import { getPayloadClient } from '../../lib/payload'

interface Post {
  id: string
  title: string
  slug: string
  content: any
  excerpt?: string
  publishedDate?: string
  status: 'draft' | 'published'
}

const { slug } = Astro.params

let post: Post | null = null
let error: string | null = null

try {
  const payload = await getPayloadClient()
  const result = await payload.find({
    collection: 'posts',
    where: {
      slug: { equals: slug },
    },
    limit: 1,
  })

  if (result.docs.length === 0) {
    return Astro.redirect('/404')
  }

  post = result.docs[0] as Post
} catch (e) {
  console.error('Error fetching post:', e)
  error = 'Błąd połączenia z bazą danych.'
}

function renderLexicalContent(content: any): string {
  if (!content || !content.root) return ''

  function renderNode(node: any): string {
    if (!node) return ''

    switch (node.type) {
      case 'root':
        return node.children?.map(renderNode).join('') || ''
      case 'paragraph':
        const pContent = node.children?.map(renderNode).join('') || ''
        return `<p class="mb-4 text-gray-700 leading-relaxed">${pContent}</p>`
      case 'heading':
        const hContent = node.children?.map(renderNode).join('') || ''
        const tag = node.tag || 'h2'
        const headingClasses = tag === 'h1'
          ? 'text-3xl font-bold mt-8 mb-4 text-gray-800'
          : tag === 'h2'
          ? 'text-2xl font-semibold mt-6 mb-3 text-gray-800'
          : 'text-xl font-medium mt-4 mb-2 text-gray-800'
        return `<${tag} class="${headingClasses}">${hContent}</${tag}>`
      case 'text':
        let text = node.text || ''
        if (node.format & 1) text = `<strong class="font-semibold">${text}</strong>`
        if (node.format & 2) text = `<em>${text}</em>`
        if (node.format & 8) text = `<u>${text}</u>`
        return text
      case 'link':
        const linkContent = node.children?.map(renderNode).join('') || ''
        return `<a href="${node.url}" class="text-blue-600 hover:text-blue-800 underline">${linkContent}</a>`
      case 'list':
        const listTag = node.listType === 'number' ? 'ol' : 'ul'
        const listItems = node.children?.map(renderNode).join('') || ''
        const listClass = node.listType === 'number'
          ? 'list-decimal ml-6 mb-4 space-y-1'
          : 'list-disc ml-6 mb-4 space-y-1'
        return `<${listTag} class="${listClass}">${listItems}</${listTag}>`
      case 'listitem':
        const liContent = node.children?.map(renderNode).join('') || ''
        return `<li class="text-gray-700">${liContent}</li>`
      case 'quote':
        const quoteContent = node.children?.map(renderNode).join('') || ''
        return `<blockquote class="border-l-4 border-gray-300 pl-4 my-4 italic text-gray-600">${quoteContent}</blockquote>`
      default:
        if (node.children) {
          return node.children.map(renderNode).join('')
        }
        return ''
    }
  }

  return renderNode(content.root)
}

const htmlContent = post ? renderLexicalContent(post.content) : ''
---

<Layout title={`${post?.title || 'Post'} | Astro + Payload CMS`}>
  <div class="max-w-3xl mx-auto px-4 py-8">
    <a
      href="/"
      class="inline-flex items-center text-blue-600 hover:text-blue-800 mb-6 transition-colors"
    >
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Powrót do listy
    </a>

    {error && (
      <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {post && (
      <article class="bg-white p-8 rounded-xl shadow-sm">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">{post.title}</h1>

        {post.publishedDate && (
          <p class="text-gray-400 mb-6 pb-4 border-b border-gray-100">
            Opublikowano: {new Date(post.publishedDate).toLocaleDateString('pl-PL', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </p>
        )}

        <div class="prose prose-gray max-w-none" set:html={htmlContent} />
      </article>
    )}
  </div>
</Layout>
