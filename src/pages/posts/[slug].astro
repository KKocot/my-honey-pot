---
import Layout from '../../layouts/Layout.astro'
import { getPayloadClient } from '../../lib/payload'

interface Post {
  id: string
  title: string
  slug: string
  content: unknown
  excerpt?: string
  publishedDate?: string
  status: 'draft' | 'published'
}

interface LexicalNode {
  type: string
  children?: LexicalNode[]
  text?: string
  format?: number
  tag?: string
  url?: string
  listType?: string
}

interface LexicalContent {
  root?: LexicalNode
}

const { slug } = Astro.params

let post: Post | null = null
let error: string | null = null

try {
  const payload = await getPayloadClient()
  const result = await payload.find({
    collection: 'posts',
    where: {
      slug: { equals: slug },
    },
    limit: 1,
  })

  if (result.docs.length === 0) {
    return Astro.redirect('/404')
  }

  post = result.docs[0] as Post
} catch (e) {
  console.error('Error fetching post:', e)
  error = 'Błąd połączenia z bazą danych.'
}

function renderLexicalContent(content: unknown): string {
  const lexicalContent = content as LexicalContent
  if (!lexicalContent || !lexicalContent.root) return ''

  function renderNode(node: LexicalNode): string {
    if (!node) return ''

    switch (node.type) {
      case 'root':
        return node.children?.map(renderNode).join('') || ''
      case 'paragraph': {
        const pContent = node.children?.map(renderNode).join('') || ''
        return `<p class="mb-4 text-text leading-relaxed">${pContent}</p>`
      }
      case 'heading': {
        const hContent = node.children?.map(renderNode).join('') || ''
        const tag = node.tag || 'h2'
        const headingClasses = tag === 'h1'
          ? 'text-3xl font-bold mt-8 mb-4 text-text'
          : tag === 'h2'
          ? 'text-2xl font-semibold mt-6 mb-3 text-text'
          : 'text-xl font-medium mt-4 mb-2 text-text'
        return `<${tag} class="${headingClasses}">${hContent}</${tag}>`
      }
      case 'text': {
        let text = node.text || ''
        const format = node.format || 0
        if (format & 1) text = `<strong class="font-semibold">${text}</strong>`
        if (format & 2) text = `<em>${text}</em>`
        if (format & 8) text = `<u>${text}</u>`
        return text
      }
      case 'link': {
        const linkContent = node.children?.map(renderNode).join('') || ''
        return `<a href="${node.url}" class="text-primary hover:text-primary-hover underline">${linkContent}</a>`
      }
      case 'list': {
        const listTag = node.listType === 'number' ? 'ol' : 'ul'
        const listItems = node.children?.map(renderNode).join('') || ''
        const listClass = node.listType === 'number'
          ? 'list-decimal ml-6 mb-4 space-y-1'
          : 'list-disc ml-6 mb-4 space-y-1'
        return `<${listTag} class="${listClass}">${listItems}</${listTag}>`
      }
      case 'listitem': {
        const liContent = node.children?.map(renderNode).join('') || ''
        return `<li class="text-text">${liContent}</li>`
      }
      case 'quote': {
        const quoteContent = node.children?.map(renderNode).join('') || ''
        return `<blockquote class="border-l-4 border-border pl-4 my-4 italic text-text-muted">${quoteContent}</blockquote>`
      }
      default:
        if (node.children) {
          return node.children.map(renderNode).join('')
        }
        return ''
    }
  }

  return renderNode(lexicalContent.root)
}

const htmlContent = post ? renderLexicalContent(post.content) : ''
---

<Layout title={`${post?.title || 'Post'} | Astro + Payload CMS`}>
  <div class="max-w-3xl mx-auto px-4 py-8">
    <a
      href="/"
      class="inline-flex items-center text-primary hover:text-primary-hover mb-6 transition-colors"
    >
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Powrót do listy
    </a>

    {error && (
      <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-6">
        <strong>Błąd:</strong> {error}
      </div>
    )}

    {post && (
      <article class="bg-bg-card p-8 rounded-xl shadow-sm border border-border">
        <h1 class="text-3xl font-bold text-text mb-2">{post.title}</h1>

        {post.publishedDate && (
          <p class="text-text-muted mb-6 pb-4 border-b border-border">
            Opublikowano: {new Date(post.publishedDate).toLocaleDateString('pl-PL', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </p>
        )}

        <div class="prose max-w-none" set:html={htmlContent} />
      </article>
    )}
  </div>
</Layout>
